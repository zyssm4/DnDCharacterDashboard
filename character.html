<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Charakter bearbeiten - Druiden Tracker</title>
    <link rel="icon" type="image/svg+xml" href="assets/icons/favicon.svg">
    <link rel="stylesheet" href="assets/css/shared-styles.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #2d5016 0%, #1a2f0d 100%);
            color: #e8f5e9;
            min-height: 100vh;
            padding: 20px;
        }

        /* Navigation */
        nav {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        nav a {
            color: #a5d6a7;
            text-decoration: none;
            padding: 8px 16px;
            border-radius: 5px;
            transition: all 0.3s;
        }

        nav a:hover {
            background: rgba(165, 214, 167, 0.2);
            color: #c8e6c9;
        }

        nav a.active {
            background: #4caf50;
            color: white;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            margin-bottom: 30px;
            color: #c8e6c9;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }

        .section {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }

        .section h2 {
            color: #a5d6a7;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #4caf50;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #c8e6c9;
            font-weight: 600;
        }

        input[type="text"] {
            width: 100%;
            padding: 10px;
            border-radius: 5px;
            border: 2px solid #4caf50;
            background: rgba(255, 255, 255, 0.1);
            color: #e8f5e9;
            font-size: 16px;
        }

        input[type="text"]:focus {
            outline: none;
            border-color: #66bb6a;
            background: rgba(255, 255, 255, 0.15);
        }

        select {
            width: 100%;
            padding: 10px;
            border-radius: 5px;
            border: 2px solid #4caf50;
            background: rgba(255, 255, 255, 0.1);
            color: #e8f5e9;
            font-size: 16px;
        }

        select:focus {
            outline: none;
            border-color: #66bb6a;
        }

        /* Stat controls */
        .stat-control {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
            padding: 15px;
            background: rgba(76, 175, 80, 0.1);
            border-radius: 8px;
        }

        .stat-label {
            flex: 1;
            font-weight: 600;
            color: #c8e6c9;
        }

        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #4caf50;
            min-width: 60px;
            text-align: center;
        }

        .stat-modifier {
            font-size: 18px;
            color: #81c784;
            min-width: 50px;
            text-align: center;
        }

        .stat-buttons {
            display: flex;
            gap: 8px;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s;
        }

        .btn-minus {
            background: #e57373;
            color: white;
        }

        .btn-minus:hover {
            background: #ef5350;
            transform: scale(1.05);
        }

        .btn-plus {
            background: #81c784;
            color: white;
        }

        .btn-plus:hover {
            background: #66bb6a;
            transform: scale(1.05);
        }

        .btn-primary {
            background: #4caf50;
            color: white;
            padding: 12px 24px;
            width: 100%;
            font-size: 18px;
        }

        .btn-primary:hover {
            background: #45a049;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }

        .btn-back {
            background: #757575;
            color: white;
            padding: 12px 24px;
            width: 100%;
            font-size: 18px;
            margin-top: 10px;
        }

        .btn-back:hover {
            background: #616161;
        }

        /* Grid for abilities */
        .abilities-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 10px;
        }

        /* HP and AC section */
        .combat-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        @media (max-width: 768px) {
            nav {
                flex-direction: column;
                gap: 10px;
            }

            .container {
                padding: 15px;
            }

            h1 {
                font-size: 1.5em;
            }

            .section {
                padding: 15px;
            }

            .stat-control {
                flex-wrap: wrap;
                gap: 10px;
            }

            .stat-label {
                width: 100%;
                margin-bottom: 5px;
            }

            .combat-stats {
                grid-template-columns: 1fr;
            }

            .btn-primary, .btn-back {
                font-size: 16px;
                padding: 10px 20px;
            }
        }

        @media (max-width: 480px) {
            .stat-buttons {
                width: 100%;
                justify-content: center;
            }
        }

        .save-indicator {
            text-align: center;
            padding: 10px;
            border-radius: 5px;
            margin-top: 20px;
            display: none;
        }

        .save-indicator.success {
            background: rgba(76, 175, 80, 0.3);
            color: #c8e6c9;
            display: block;
        }

        .save-indicator.error {
            background: rgba(229, 115, 115, 0.3);
            color: #ffcdd2;
            display: block;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(255,255,255,0.3);
            border-top-color: #fff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .notification {
            padding: 15px 20px;
            margin-bottom: 10px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            animation: slideIn 0.3s ease;
            max-width: 300px;
        }

        .notification.success { background: #4CAF50; }
        .notification.error { background: #f44336; }
        .notification.warning { background: #ff9800; }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* Level-Up Modal */
        .level-up-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .level-up-modal.show {
            display: flex;
        }

        .level-up-content {
            background: linear-gradient(135deg, #2d5016 0%, #1a2f0d 100%);
            border: 3px solid #4caf50;
            border-radius: 15px;
            padding: 30px;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
            animation: slideDown 0.3s ease-out;
        }

        @keyframes slideDown {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .level-up-header {
            text-align: center;
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 2px solid #4caf50;
        }

        .level-up-header h2 {
            color: #c8e6c9;
            font-size: 32px;
            margin-bottom: 10px;
        }

        .level-up-subtitle {
            color: #a5d6a7;
            font-size: 18px;
            font-weight: 600;
        }

        .level-up-body {
            color: #e8f5e9;
            line-height: 1.6;
        }

        .level-up-section {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            border-left: 4px solid #4caf50;
        }

        .level-up-section h3 {
            color: #a5d6a7;
            margin-bottom: 10px;
            font-size: 20px;
        }

        .level-up-feature {
            margin: 10px 0;
            padding: 10px;
            background: rgba(76, 175, 80, 0.1);
            border-radius: 5px;
        }

        .level-up-feature-name {
            font-weight: bold;
            color: #c8e6c9;
            margin-bottom: 5px;
        }

        .level-up-feature-desc {
            color: #a5d6a7;
            font-size: 14px;
        }

        .level-up-footer {
            margin-top: 25px;
            text-align: center;
            padding-top: 20px;
            border-top: 2px solid #4caf50;
        }

        .spell-slots-table {
            width: 100%;
            margin: 10px 0;
            border-collapse: collapse;
        }

        .spell-slots-table th,
        .spell-slots-table td {
            padding: 8px;
            text-align: center;
            border: 1px solid #4caf50;
        }

        .spell-slots-table th {
            background: rgba(76, 175, 80, 0.3);
            color: #c8e6c9;
            font-weight: bold;
        }

        .spell-slots-table td {
            background: rgba(0, 0, 0, 0.2);
            color: #a5d6a7;
        }

        .ability-improvement {
            background: rgba(255, 215, 0, 0.2);
            border-left-color: #ffd700;
        }
    </style>
</head>
<body>
    <div id="notification-container" style="position: fixed; top: 20px; right: 20px; z-index: 1000;"></div>
    <div id="loading-overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 999; justify-content: center; align-items: center;">
        <div class="loading-spinner"></div>
    </div>

    <nav>
        <a href="dashboard.html">Dashboard</a>
        <a href="character.html" class="active">Charakter</a>
        <a href="spells.html">Zauber</a>
        <a href="equipment.html">Ausr√ºstung</a>
    </nav>

    <div class="container">
        <h1>Charakter bearbeiten</h1>

        <!-- Basic Info Section -->
        <div class="section">
            <h2>Grundinformationen</h2>

            <div class="form-group">
                <label for="charName">Charaktername</label>
                <input type="text" id="charName" placeholder="Name des Druiden">
            </div>

            <div class="stat-control">
                <div class="stat-label">Stufe</div>
                <div class="stat-value" id="levelValue">1</div>
                <div class="stat-buttons">
                    <button class="btn btn-minus" onclick="changeLevel(-1)">-</button>
                    <button class="btn btn-plus" onclick="changeLevel(1)">+</button>
                </div>
            </div>

            <div class="form-group">
                <label for="druidCircle">Druiden-Zirkel</label>
                <select id="druidCircle">
                    <option value="land">Zirkel des Landes</option>
                    <option value="moon">Zirkel des Mondes</option>
                    <option value="dreams">Zirkel der Tr√§ume</option>
                    <option value="shepherd">Zirkel des Hirten</option>
                    <option value="spores">Zirkel der Sporen</option>
                    <option value="wildfire">Zirkel des Wildfeuers</option>
                    <option value="stars">Zirkel der Sterne</option>
                </select>
            </div>

            <div class="form-group">
                <label>üí∞ W√§hrung</label>
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px;">
                    <div class="stat-control">
                        <div class="stat-label">Gold (GP)</div>
                        <div class="stat-value" id="goldValue">0</div>
                        <div class="stat-buttons">
                            <button class="btn btn-minus" onclick="changeCurrency('gold', -1)">-</button>
                            <button class="btn btn-plus" onclick="changeCurrency('gold', 1)">+</button>
                        </div>
                    </div>
                    <div class="stat-control">
                        <div class="stat-label">Silber (SP)</div>
                        <div class="stat-value" id="silverValue">0</div>
                        <div class="stat-buttons">
                            <button class="btn btn-minus" onclick="changeCurrency('silver', -1)">-</button>
                            <button class="btn btn-plus" onclick="changeCurrency('silver', 1)">+</button>
                        </div>
                    </div>
                    <div class="stat-control">
                        <div class="stat-label">Kupfer (CP)</div>
                        <div class="stat-value" id="copperValue">0</div>
                        <div class="stat-buttons">
                            <button class="btn btn-minus" onclick="changeCurrency('copper', -1)">-</button>
                            <button class="btn btn-plus" onclick="changeCurrency('copper', 1)">+</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Ability Scores Section -->
        <div class="section">
            <h2>Attributswerte</h2>
            <div class="abilities-grid">
                <div class="stat-control">
                    <div class="stat-label">St√§rke (STR)</div>
                    <div class="stat-value" id="strengthValue">10</div>
                    <div class="stat-modifier" id="strengthMod">+0</div>
                    <div class="stat-buttons">
                        <button class="btn btn-minus" onclick="changeStat('strength', -1)">-</button>
                        <button class="btn btn-plus" onclick="changeStat('strength', 1)">+</button>
                    </div>
                </div>

                <div class="stat-control">
                    <div class="stat-label">Geschicklichkeit (DEX)</div>
                    <div class="stat-value" id="dexterityValue">10</div>
                    <div class="stat-modifier" id="dexterityMod">+0</div>
                    <div class="stat-buttons">
                        <button class="btn btn-minus" onclick="changeStat('dexterity', -1)">-</button>
                        <button class="btn btn-plus" onclick="changeStat('dexterity', 1)">+</button>
                    </div>
                </div>

                <div class="stat-control">
                    <div class="stat-label">Konstitution (CON)</div>
                    <div class="stat-value" id="constitutionValue">10</div>
                    <div class="stat-modifier" id="constitutionMod">+0</div>
                    <div class="stat-buttons">
                        <button class="btn btn-minus" onclick="changeStat('constitution', -1)">-</button>
                        <button class="btn btn-plus" onclick="changeStat('constitution', 1)">+</button>
                    </div>
                </div>

                <div class="stat-control">
                    <div class="stat-label">Intelligenz (INT)</div>
                    <div class="stat-value" id="intelligenceValue">10</div>
                    <div class="stat-modifier" id="intelligenceMod">+0</div>
                    <div class="stat-buttons">
                        <button class="btn btn-minus" onclick="changeStat('intelligence', -1)">-</button>
                        <button class="btn btn-plus" onclick="changeStat('intelligence', 1)">+</button>
                    </div>
                </div>

                <div class="stat-control">
                    <div class="stat-label">Weisheit (WIS)</div>
                    <div class="stat-value" id="wisdomValue">10</div>
                    <div class="stat-modifier" id="wisdomMod">+0</div>
                    <div class="stat-buttons">
                        <button class="btn btn-minus" onclick="changeStat('wisdom', -1)">-</button>
                        <button class="btn btn-plus" onclick="changeStat('wisdom', 1)">+</button>
                    </div>
                </div>

                <div class="stat-control">
                    <div class="stat-label">Charisma (CHA)</div>
                    <div class="stat-value" id="charismaValue">10</div>
                    <div class="stat-modifier" id="charismaMod">+0</div>
                    <div class="stat-buttons">
                        <button class="btn btn-minus" onclick="changeStat('charisma', -1)">-</button>
                        <button class="btn btn-plus" onclick="changeStat('charisma', 1)">+</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Combat Stats Section -->
        <div class="section">
            <h2>Kampfwerte</h2>
            <div class="combat-stats">
                <div>
                    <div class="stat-control">
                        <div class="stat-label">R√ºstungsklasse (AC)</div>
                        <div class="stat-value" id="acValue">10</div>
                        <div class="stat-buttons">
                            <button class="btn btn-minus" onclick="changeAC(-1)">-</button>
                            <button class="btn btn-plus" onclick="changeAC(1)">+</button>
                        </div>
                    </div>
                </div>

                <div>
                    <div class="stat-control">
                        <div class="stat-label">Max Trefferpunkte</div>
                        <div class="stat-value" id="maxHPValue">8</div>
                        <div class="stat-buttons">
                            <button class="btn btn-minus" onclick="changeMaxHP(-1)">-</button>
                            <button class="btn btn-plus" onclick="changeMaxHP(1)">+</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Save Buttons -->
        <div class="section">
            <button class="btn btn-primary" onclick="saveAllChanges()">√Ñnderungen speichern</button>
            <button class="btn btn-back" onclick="goBack()">Zur√ºck zum Dashboard</button>
            <div class="save-indicator" id="saveIndicator"></div>
        </div>
    </div>

    <!-- Level-Up Guide Modal -->
    <div id="levelUpModal" class="level-up-modal">
        <div class="level-up-content">
            <div class="level-up-header">
                <h2>üéâ Level Up!</h2>
                <span class="level-up-subtitle" id="levelUpSubtitle"></span>
            </div>
            <div class="level-up-body" id="levelUpBody">
                <!-- Content wird dynamisch eingef√ºgt -->
            </div>
            <div class="level-up-footer">
                <button class="btn btn-primary" onclick="closeLevelUpModal()">Verstanden!</button>
            </div>
        </div>
    </div>

    <script>
        const API_URL = 'db_actions.php';
        const CHARACTER_ID = new URLSearchParams(window.location.search).get('id') || 1;

        function showNotification(message, type = 'success') {
            const container = document.getElementById('notification-container');
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            container.appendChild(notification);
            setTimeout(() => notification.remove(), 3000);
        }

        function showLoading() {
            document.getElementById('loading-overlay').style.display = 'flex';
        }

        function hideLoading() {
            document.getElementById('loading-overlay').style.display = 'none';
        }

        let characterStats = {
            level: 1,
            strength: 10,
            dexterity: 10,
            constitution: 10,
            intelligence: 10,
            wisdom: 10,
            charisma: 10,
            armorClass: 10,
            maxHP: 8,
            currentHP: 8,
            gold: 0,
            silver: 0,
            copper: 0
        };

        let characterName = '';
        let druidCircle = 'land';
        let savingThrowProficiencies = [];
        let skillProficiencies = [];

        // Load character data on page load
        window.addEventListener('DOMContentLoaded', loadCharacter);

        async function loadCharacter() {
            try {
                showLoading();
                const response = await fetch(`${API_URL}?action=character&id=${CHARACTER_ID}`);
                const data = await response.json();

                if (data.success) {
                    const char = data.data;

                    // Update character stats
                    characterStats = {
                        level: parseInt(char.level),
                        strength: parseInt(char.strength),
                        dexterity: parseInt(char.dexterity),
                        constitution: parseInt(char.constitution),
                        intelligence: parseInt(char.intelligence),
                        wisdom: parseInt(char.wisdom),
                        charisma: parseInt(char.charisma),
                        armorClass: parseInt(char.armor_class),
                        maxHP: parseInt(char.max_hp),
                        currentHP: parseInt(char.current_hp),
                        gold: parseInt(char.gold || 0),
                        silver: parseInt(char.silver || 0),
                        copper: parseInt(char.copper || 0)
                    };

                    characterName = char.name;
                    druidCircle = char.druid_circle || 'land'; // Default to 'land' if null/undefined

                    // Load proficiencies
                    savingThrowProficiencies = char.saving_throw_proficiencies || ['intelligence', 'wisdom'];
                    skillProficiencies = char.skill_proficiencies || [];

                    // Update UI
                    document.getElementById('charName').value = characterName;

                    // Set druid circle - use requestAnimationFrame to ensure DOM is ready
                    requestAnimationFrame(() => {
                        const circleSelect = document.getElementById('druidCircle');
                        if (circleSelect) {
                            circleSelect.value = druidCircle;
                            console.log('Druid circle set to:', druidCircle);
                        } else {
                            console.warn('Druid circle select element not found');
                        }
                    });

                    updateAllStats();
                } else {
                    throw new Error(data.error || 'Charakter konnte nicht geladen werden');
                }
            } catch (error) {
                console.error('Error loading character:', error);
                showNotification(error.message || 'Fehler beim Laden des Charakters', 'error');
            } finally {
                hideLoading();
            }
        }

        function changeLevel(delta) {
            const oldLevel = characterStats.level;
            const newLevel = Math.max(1, Math.min(20, characterStats.level + delta));

            // Show level-up guide if leveling up
            if (newLevel > oldLevel) {
                showLevelUpGuide(oldLevel, newLevel);
            }

            characterStats.level = newLevel;
            updateAllStats();
        }

        function changeStat(statName, delta) {
            characterStats[statName] = Math.max(1, Math.min(30, characterStats[statName] + delta));
            updateAllStats();
        }

        function changeAC(delta) {
            characterStats.armorClass = Math.max(0, Math.min(30, characterStats.armorClass + delta));
            updateAllStats();
        }

        function changeMaxHP(delta) {
            characterStats.maxHP = Math.max(1, characterStats.maxHP + delta);
            // Adjust current HP if it exceeds new max
            if (characterStats.currentHP > characterStats.maxHP) {
                characterStats.currentHP = characterStats.maxHP;
            }
            updateAllStats();
        }

        function updateAllStats() {
            // Update level
            document.getElementById('levelValue').textContent = characterStats.level;

            // Update ability scores and modifiers
            const abilities = ['strength', 'dexterity', 'constitution', 'intelligence', 'wisdom', 'charisma'];
            abilities.forEach(ability => {
                const value = characterStats[ability];
                const modifier = Math.floor((value - 10) / 2);

                document.getElementById(`${ability}Value`).textContent = value;
                document.getElementById(`${ability}Mod`).textContent = modifier >= 0 ? `+${modifier}` : modifier;
            });

            // Update combat stats
            document.getElementById('acValue').textContent = characterStats.armorClass;
            document.getElementById('maxHPValue').textContent = characterStats.maxHP;

            // Update currency
            document.getElementById('goldValue').textContent = characterStats.gold;
            document.getElementById('silverValue').textContent = characterStats.silver;
            document.getElementById('copperValue').textContent = characterStats.copper;
        }

        function changeCurrency(type, delta) {
            characterStats[type] = Math.max(0, characterStats[type] + delta);
            updateAllStats();
        }

        async function saveAllChanges() {
            try {
                showLoading();
                // Get current form values
                characterName = document.getElementById('charName').value || 'Unbenannter Druide';
                druidCircle = document.getElementById('druidCircle').value;

                const updateData = {
                    id: CHARACTER_ID,
                    name: characterName,
                    level: characterStats.level,
                    druid_circle: druidCircle,
                    strength: characterStats.strength,
                    dexterity: characterStats.dexterity,
                    constitution: characterStats.constitution,
                    intelligence: characterStats.intelligence,
                    wisdom: characterStats.wisdom,
                    charisma: characterStats.charisma,
                    armor_class: characterStats.armorClass,
                    max_hp: characterStats.maxHP,
                    current_hp: characterStats.currentHP,
                    gold: characterStats.gold,
                    silver: characterStats.silver,
                    copper: characterStats.copper,
                    saving_throw_proficiencies: savingThrowProficiencies,
                    skill_proficiencies: skillProficiencies
                };

                const response = await fetch(`${API_URL}?action=update_character`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(updateData)
                });

                const data = await response.json();

                if (data.success) {
                    showNotification('√Ñnderungen erfolgreich gespeichert!');
                } else {
                    throw new Error(data.error || 'Fehler beim Speichern');
                }
            } catch (error) {
                console.error('Error saving character:', error);
                showNotification(error.message || 'Fehler beim Speichern', 'error');
            } finally {
                hideLoading();
            }
        }

        function showSaveIndicator(message, type) {
            const indicator = document.getElementById('saveIndicator');
            indicator.textContent = message;
            indicator.className = `save-indicator ${type}`;

            setTimeout(() => {
                indicator.style.display = 'none';
            }, 3000);
        }

        function goBack() {
            window.location.href = 'dashboard.html';
        }

        // Add event listeners for name and circle changes
        document.getElementById('charName').addEventListener('change', () => {
            characterName = document.getElementById('charName').value;
        });

        document.getElementById('druidCircle').addEventListener('change', () => {
            druidCircle = document.getElementById('druidCircle').value;
        });

        // Level-Up Guide Functions
        const druidLevelUpData = {
            2: {
                features: [
                    { name: 'Wildgestalt', desc: 'Du kannst dich 2x pro kurzer oder langer Rast in Tierformen verwandeln. Max CR: 1/4, keine Schwimm- oder Fluggeschwindigkeit.' },
                    { name: 'Druiden-Zirkel', desc: 'W√§hle deinen Druiden-Zirkel (Kreis des Landes oder Kreis des Mondes).' }
                ],
                spellSlots: { 1: 3, 2: 0, 3: 0, 4: 0, 5: 0, 6: 0, 7: 0, 8: 0, 9: 0 }
            },
            3: {
                features: [],
                spellSlots: { 1: 4, 2: 2, 3: 0, 4: 0, 5: 0, 6: 0, 7: 0, 8: 0, 9: 0 },
                spellsKnown: 2
            },
            4: {
                features: [
                    { name: 'Attributsverbesserung', desc: 'Du erh√§ltst +2 auf ein Attribut oder +1 auf zwei verschiedene Attribute (oder ein Talent).' }
                ],
                spellSlots: { 1: 4, 2: 3, 3: 0, 4: 0, 5: 0, 6: 0, 7: 0, 8: 0, 9: 0 },
                cantripsKnown: 3,
                abilityImprovement: true
            },
            5: {
                features: [],
                spellSlots: { 1: 4, 2: 3, 3: 2, 4: 0, 5: 0, 6: 0, 7: 0, 8: 0, 9: 0 }
            },
            6: {
                features: [
                    { name: 'Zirkel-Feature', desc: 'Du erh√§ltst ein Feature deines gew√§hlten Druiden-Zirkels.' }
                ],
                spellSlots: { 1: 4, 2: 3, 3: 3, 4: 0, 5: 0, 6: 0, 7: 0, 8: 0, 9: 0 }
            },
            7: {
                features: [],
                spellSlots: { 1: 4, 2: 3, 3: 3, 4: 1, 5: 0, 6: 0, 7: 0, 8: 0, 9: 0 }
            },
            8: {
                features: [
                    { name: 'Attributsverbesserung', desc: 'Du erh√§ltst +2 auf ein Attribut oder +1 auf zwei verschiedene Attribute (oder ein Talent).' },
                    { name: 'Wildgestalt-Verbesserung', desc: 'Schwimmgeschwindigkeit erlaubt (Kreis des Landes) oder CR 1 (Kreis des Mondes).' }
                ],
                spellSlots: { 1: 4, 2: 3, 3: 3, 4: 2, 5: 0, 6: 0, 7: 0, 8: 0, 9: 0 },
                abilityImprovement: true
            },
            9: {
                features: [],
                spellSlots: { 1: 4, 2: 3, 3: 3, 4: 3, 5: 1, 6: 0, 7: 0, 8: 0, 9: 0 }
            },
            10: {
                features: [
                    { name: 'Zirkel-Feature', desc: 'Du erh√§ltst ein weiteres Feature deines Druiden-Zirkels.' }
                ],
                spellSlots: { 1: 4, 2: 3, 3: 3, 4: 3, 5: 2, 6: 0, 7: 0, 8: 0, 9: 0 },
                cantripsKnown: 4
            },
            11: {
                features: [],
                spellSlots: { 1: 4, 2: 3, 3: 3, 4: 3, 5: 2, 6: 1, 7: 0, 8: 0, 9: 0 }
            },
            12: {
                features: [
                    { name: 'Attributsverbesserung', desc: 'Du erh√§ltst +2 auf ein Attribut oder +1 auf zwei verschiedene Attribute (oder ein Talent).' }
                ],
                spellSlots: { 1: 4, 2: 3, 3: 3, 4: 3, 5: 2, 6: 1, 7: 0, 8: 0, 9: 0 },
                abilityImprovement: true
            },
            13: {
                features: [],
                spellSlots: { 1: 4, 2: 3, 3: 3, 4: 3, 5: 2, 6: 1, 7: 1, 8: 0, 9: 0 }
            },
            14: {
                features: [
                    { name: 'Zirkel-Feature', desc: 'Du erh√§ltst ein weiteres Feature deines Druiden-Zirkels.' }
                ],
                spellSlots: { 1: 4, 2: 3, 3: 3, 4: 3, 5: 2, 6: 1, 7: 1, 8: 0, 9: 0 }
            },
            15: {
                features: [],
                spellSlots: { 1: 4, 2: 3, 3: 3, 4: 3, 5: 2, 6: 1, 7: 1, 8: 1, 9: 0 }
            },
            16: {
                features: [
                    { name: 'Attributsverbesserung', desc: 'Du erh√§ltst +2 auf ein Attribut oder +1 auf zwei verschiedene Attribute (oder ein Talent).' }
                ],
                spellSlots: { 1: 4, 2: 3, 3: 3, 4: 3, 5: 2, 6: 1, 7: 1, 8: 1, 9: 0 },
                abilityImprovement: true
            },
            17: {
                features: [],
                spellSlots: { 1: 4, 2: 3, 3: 3, 4: 3, 5: 2, 6: 1, 7: 1, 8: 1, 9: 1 }
            },
            18: {
                features: [
                    { name: 'Zeitlose Gestalt', desc: 'Du alterst nur noch 1 Jahr pro 10 Jahren und kannst nicht magisch gealtert werden.' },
                    { name: 'Bestiengestalt', desc: 'Du kannst Zauber in Tierform wirken.' }
                ],
                spellSlots: { 1: 4, 2: 3, 3: 3, 4: 3, 5: 3, 6: 1, 7: 1, 8: 1, 9: 1 }
            },
            19: {
                features: [
                    { name: 'Attributsverbesserung', desc: 'Du erh√§ltst +2 auf ein Attribut oder +1 auf zwei verschiedene Attribute (oder ein Talent).' }
                ],
                spellSlots: { 1: 4, 2: 3, 3: 3, 4: 3, 5: 3, 6: 2, 7: 1, 8: 1, 9: 1 },
                abilityImprovement: true
            },
            20: {
                features: [
                    { name: 'Erz-Druide', desc: 'Du kannst deine Wildgestalt unbegrenzt oft nutzen. Zudem ignorierst du verbale und somatische Komponenten deiner Druiden-Zauber und kannst nicht von nicht-magischen Pflanzen behindert werden.' }
                ],
                spellSlots: { 1: 4, 2: 3, 3: 3, 4: 3, 5: 3, 6: 2, 7: 2, 8: 1, 9: 1 }
            }
        };

        function showLevelUpGuide(oldLevel, newLevel) {
            const levelData = druidLevelUpData[newLevel];
            if (!levelData) {
                console.warn('No level-up data for level', newLevel);
                return;
            }

            // Set subtitle
            document.getElementById('levelUpSubtitle').textContent = `Level ${oldLevel} ‚Üí Level ${newLevel}`;

            let content = '';

            // Features
            if (levelData.features && levelData.features.length > 0) {
                const sectionClass = levelData.abilityImprovement ? 'level-up-section ability-improvement' : 'level-up-section';
                content += `
                    <div class="${sectionClass}">
                        <h3>üåü Neue Features</h3>
                        ${levelData.features.map(feature => `
                            <div class="level-up-feature">
                                <div class="level-up-feature-name">${feature.name}</div>
                                <div class="level-up-feature-desc">${feature.desc}</div>
                            </div>
                        `).join('')}
                    </div>
                `;
            }

            // Spell Slots
            if (levelData.spellSlots) {
                const oldLevelData = druidLevelUpData[oldLevel];
                const oldSlots = oldLevelData?.spellSlots || {};

                let changedSlots = [];
                for (let level = 1; level <= 9; level++) {
                    const newCount = levelData.spellSlots[level] || 0;
                    const oldCount = oldSlots[level] || 0;
                    if (newCount !== oldCount) {
                        changedSlots.push({ level, oldCount, newCount });
                    }
                }

                if (changedSlots.length > 0) {
                    content += `
                        <div class="level-up-section">
                            <h3>‚ú® Zauberpl√§tze</h3>
                            <table class="spell-slots-table">
                                <tr>
                                    <th>Grad</th>
                                    ${changedSlots.map(slot => `<th>${slot.level}</th>`).join('')}
                                </tr>
                                <tr>
                                    <td><strong>Neu</strong></td>
                                    ${changedSlots.map(slot => `<td>${slot.newCount}</td>`).join('')}
                                </tr>
                            </table>
                        </div>
                    `;
                }
            }

            // Cantrips
            if (levelData.cantripsKnown) {
                content += `
                    <div class="level-up-section">
                        <h3>üîÆ Zaubertricks</h3>
                        <p>Du kannst jetzt <strong>${levelData.cantripsKnown}</strong> Zaubertricks (Cantrips) kennen.</p>
                    </div>
                `;
            }

            // Spells Known
            if (levelData.spellsKnown) {
                content += `
                    <div class="level-up-section">
                        <h3>üìö Zauber</h3>
                        <p>Du kannst <strong>${levelData.spellsKnown}</strong> neue Zauber lernen.</p>
                    </div>
                `;
            }

            // Proficiency Bonus Update
            const newProfBonus = Math.floor((newLevel - 1) / 4) + 2;
            const oldProfBonus = Math.floor((oldLevel - 1) / 4) + 2;
            if (newProfBonus > oldProfBonus) {
                content += `
                    <div class="level-up-section">
                        <h3>‚¨ÜÔ∏è √úbungsbonus</h3>
                        <p>Dein √úbungsbonus steigt auf <strong>+${newProfBonus}</strong>!</p>
                    </div>
                `;
            }

            // Set content
            document.getElementById('levelUpBody').innerHTML = content;

            // Show modal
            document.getElementById('levelUpModal').classList.add('show');
        }

        function closeLevelUpModal() {
            document.getElementById('levelUpModal').classList.remove('show');
        }
    </script>
</body>
</html>
