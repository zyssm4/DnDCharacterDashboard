<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Magier Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0d47a1 0%, #01579b 50%, #000428 100%);
            color: #e3f2fd;
            min-height: 100vh;
        }

        .navbar {
            background: rgba(66, 165, 245, 0.9);
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .navbar h1 {
            color: #90caf9;
            font-size: 1.5em;
        }

        .nav-menu {
            display: flex;
            gap: 20px;
        }

        .nav-item {
            padding: 10px 20px;
            background: rgba(0,0,0,0.3);
            border: 2px solid #42a5f5;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
            color: #e3f2fd;
        }

        .nav-item:hover {
            background: rgba(66, 165, 245, 0.5);
            border-color: #90caf9;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: 300px 1fr 400px;
            gap: 20px;
            margin-top: 20px;
        }

        .card {
            background: rgba(13, 71, 161, 0.3);
            padding: 20px;
            border-radius: 10px;
            border: 2px solid #42a5f5;
        }

        .card h2 {
            color: #90caf9;
            margin-bottom: 15px;
            font-size: 1.3em;
        }

        .stat-compact {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: rgba(0,0,0,0.3);
            border-radius: 5px;
            margin-bottom: 8px;
            border: 1px solid #42a5f5;
        }

        .stat-compact.proficient {
            background: rgba(66, 165, 245, 0.4);
            border-color: #90caf9;
        }

        .stat-compact.prepared {
            background: rgba(66, 165, 245, 0.3);
            border-left: 4px solid #90caf9;
        }

        .stat-name {
            font-weight: bold;
            color: #90caf9;
        }

        .stat-value {
            font-size: 1.2em;
            font-weight: bold;
            color: #e3f2fd;
        }

        .ability-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }

        .ability-box {
            background: rgba(0,0,0,0.4);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            border: 2px solid #42a5f5;
        }

        .ability-box .label {
            font-size: 0.8em;
            color: #90caf9;
            margin-bottom: 5px;
        }

        .ability-box .value {
            font-size: 1.8em;
            font-weight: bold;
        }

        .ability-box .modifier {
            font-size: 1.1em;
            color: #bbdefb;
        }

        .hp-tracker {
            background: rgba(0,0,0,0.4);
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            margin-bottom: 15px;
            border: 2px solid #42a5f5;
        }

        .hp-display {
            font-size: 3em;
            font-weight: bold;
            color: #42a5f5;
        }

        .hp-max {
            font-size: 1.2em;
            color: #bbdefb;
            margin-top: 5px;
        }

        .hp-controls {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            justify-content: center;
        }

        .btn {
            padding: 10px 20px;
            background: #1976d2;
            color: #e3f2fd;
            border: 2px solid #42a5f5;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 1em;
        }

        .btn:hover {
            background: #2196f3;
            border-color: #90caf9;
        }

        .btn-small {
            padding: 5px 15px;
            font-size: 0.9em;
        }

        .btn-danger {
            background: #c62828;
            border-color: #e57373;
        }

        .btn-danger:hover {
            background: #d32f2f;
        }

        /* Arcane Recovery */
        .arcane-recovery-box {
            background: linear-gradient(135deg, rgba(66, 165, 245, 0.4), rgba(33, 150, 243, 0.2));
            padding: 20px;
            border-radius: 10px;
            border: 3px solid #90caf9;
            margin-bottom: 15px;
            text-align: center;
        }

        .arcane-recovery-box h3 {
            color: #bbdefb;
            margin-bottom: 10px;
            font-size: 1.2em;
        }

        .recovery-info {
            font-size: 1.2em;
            color: #90caf9;
            margin-bottom: 10px;
        }

        .recovery-available {
            font-size: 1em;
            color: #64b5f6;
        }

        /* Spell Slots */
        .spell-slots-compact {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
        }

        .slot-compact {
            flex: 1;
            min-width: 70px;
            background: rgba(0,0,0,0.4);
            padding: 15px 10px;
            border-radius: 8px;
            text-align: center;
            border: 2px solid #42a5f5;
        }

        .slot-compact .level {
            font-size: 0.9em;
            color: #90caf9;
            margin-bottom: 8px;
            font-weight: bold;
        }

        .slot-compact .circles {
            display: flex;
            gap: 5px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .slot-circle-mini {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            border: 2px solid #42a5f5;
            cursor: pointer;
            transition: all 0.3s;
            background: rgba(0,0,0,0.5);
        }

        .slot-circle-mini.used {
            background: #1976d2;
        }

        .slot-circle-mini:hover {
            transform: scale(1.1);
            border-color: #90caf9;
        }

        /* Spellbook */
        .spellbook-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .spellbook-header h2 {
            margin: 0;
        }

        .spell-count {
            font-size: 0.9em;
            color: #64b5f6;
        }

        .spell-tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .spell-tab {
            padding: 8px 15px;
            background: rgba(0,0,0,0.3);
            border: 2px solid #42a5f5;
            border-radius: 8px 8px 0 0;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.9em;
            color: #90caf9;
        }

        .spell-tab.active {
            background: rgba(66, 165, 245, 0.5);
            border-bottom-color: transparent;
        }

        .spell-tab:hover {
            background: rgba(66, 165, 245, 0.3);
        }

        .spell-compact {
            background: rgba(0,0,0,0.3);
            padding: 12px;
            border-radius: 5px;
            margin-bottom: 8px;
            border-left: 3px solid #42a5f5;
            cursor: pointer;
            transition: all 0.3s;
        }

        .spell-compact:hover {
            background: rgba(66, 165, 245, 0.2);
            border-left-width: 5px;
        }

        .spell-compact.ritual {
            border-right: 3px solid #ffd700;
        }

        .spell-compact.concentration {
            border-top: 2px solid #ff9800;
        }

        .spell-compact.prepared {
            background: rgba(66, 165, 245, 0.3);
            border-left-color: #90caf9;
            border-left-width: 4px;
        }

        .spell-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }

        .spell-name {
            font-weight: bold;
            color: #bbdefb;
            flex: 1;
        }

        .spell-actions {
            display: flex;
            gap: 5px;
        }

        .spell-prepare-btn {
            background: rgba(66, 165, 245, 0.5);
            border: 1px solid #42a5f5;
            padding: 3px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8em;
            transition: all 0.3s;
        }

        .spell-prepare-btn:hover {
            background: rgba(66, 165, 245, 0.8);
        }

        .spell-prepare-btn.prepared {
            background: rgba(76, 175, 80, 0.5);
            border-color: #4caf50;
        }

        .spell-level {
            font-size: 0.8em;
            color: #42a5f5;
            background: rgba(66, 165, 245, 0.3);
            padding: 2px 8px;
            border-radius: 10px;
            margin-left: 5px;
        }

        .spell-school {
            font-size: 0.75em;
            color: #64b5f6;
            font-style: italic;
        }

        .spell-details {
            font-size: 0.85em;
            color: #90caf9;
            margin-bottom: 5px;
        }

        .spell-description {
            font-size: 0.8em;
            color: #e3f2fd;
            line-height: 1.4;
            display: none;
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid rgba(66, 165, 245, 0.3);
        }

        .spell-compact.expanded .spell-description {
            display: block;
        }

        .spells-list {
            max-height: 500px;
            overflow-y: auto;
        }

        .prepared-count {
            background: rgba(66, 165, 245, 0.3);
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
            text-align: center;
            border: 2px solid #42a5f5;
        }

        .prepared-count-text {
            color: #90caf9;
            font-size: 0.9em;
        }

        .prepared-count-number {
            font-size: 1.5em;
            font-weight: bold;
            color: #42a5f5;
        }

        /* Rest buttons */
        .rest-section {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .rest-section .btn {
            flex: 1;
        }

        .feature-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .feature-item {
            background: rgba(0,0,0,0.4);
            padding: 12px;
            border-radius: 5px;
            margin-bottom: 8px;
            border-left: 3px solid #90caf9;
        }

        .feature-item h4 {
            color: #bbdefb;
            margin-bottom: 5px;
        }

        .feature-item p {
            font-size: 0.9em;
            color: #e3f2fd;
            line-height: 1.4;
        }

        @media (max-width: 1200px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Scrollbar styling */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(0,0,0,0.3);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: #42a5f5;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #2196f3;
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <h1>üîÆ <span id="characterName">Magier</span> - Stufe <span id="characterLevel">1</span></h1>
        <div class="nav-menu">
            <a href="class-selection.html" class="nav-item">üé≤ Klassenauswahl</a>
            <a href="#" class="nav-item" onclick="showEquipmentTab()">‚öîÔ∏è Ausr√ºstung</a>
            <a href="#" class="nav-item" onclick="showNotesTab()">üìú Notizen</a>
        </div>
    </nav>

    <div class="container">
        <div class="dashboard-grid">
            <!-- Left Column: Character Stats -->
            <div class="left-column">
                <div class="card">
                    <h2>Attribute</h2>
                    <div class="ability-grid">
                        <div class="ability-box">
                            <div class="label">STR</div>
                            <div class="value" id="strValue">10</div>
                            <div class="modifier" id="strMod">+0</div>
                        </div>
                        <div class="ability-box">
                            <div class="label">DEX</div>
                            <div class="value" id="dexValue">10</div>
                            <div class="modifier" id="dexMod">+0</div>
                        </div>
                        <div class="ability-box">
                            <div class="label">CON</div>
                            <div class="value" id="conValue">10</div>
                            <div class="modifier" id="conMod">+0</div>
                        </div>
                        <div class="ability-box">
                            <div class="label">INT</div>
                            <div class="value" id="intValue">10</div>
                            <div class="modifier" id="intMod">+0</div>
                        </div>
                        <div class="ability-box">
                            <div class="label">WIS</div>
                            <div class="value" id="wisValue">10</div>
                            <div class="modifier" id="wisMod">+0</div>
                        </div>
                        <div class="ability-box">
                            <div class="label">CHA</div>
                            <div class="value" id="chaValue">10</div>
                            <div class="modifier" id="chaMod">+0</div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h2>Kampfwerte</h2>
                    <div class="stat-compact">
                        <span class="stat-name">R√ºstungsklasse</span>
                        <span class="stat-value" id="armorClass">10</span>
                    </div>
                    <div class="stat-compact">
                        <span class="stat-name">Initiative</span>
                        <span class="stat-value" id="initiative">+0</span>
                    </div>
                    <div class="stat-compact">
                        <span class="stat-name">Geschwindigkeit</span>
                        <span class="stat-value" id="speed">9m</span>
                    </div>
                    <div class="stat-compact">
                        <span class="stat-name">√úbungsbonus</span>
                        <span class="stat-value" id="profBonus">+2</span>
                    </div>
                    <div class="stat-compact">
                        <span class="stat-name">Zauber-SG</span>
                        <span class="stat-value" id="spellDC">13</span>
                    </div>
                    <div class="stat-compact">
                        <span class="stat-name">Zauberangriffsbonus</span>
                        <span class="stat-value" id="spellAttack">+5</span>
                    </div>
                </div>

                <div class="card">
                    <h2>Rettungsw√ºrfe</h2>
                    <div class="stat-compact proficient">
                        <span class="stat-name">Intelligenz</span>
                        <span class="stat-value" id="saveInt">+0</span>
                    </div>
                    <div class="stat-compact proficient">
                        <span class="stat-name">Weisheit</span>
                        <span class="stat-value" id="saveWis">+0</span>
                    </div>
                    <div class="stat-compact">
                        <span class="stat-name">St√§rke</span>
                        <span class="stat-value" id="saveStr">+0</span>
                    </div>
                    <div class="stat-compact">
                        <span class="stat-name">Geschicklichkeit</span>
                        <span class="stat-value" id="saveDex">+0</span>
                    </div>
                    <div class="stat-compact">
                        <span class="stat-name">Konstitution</span>
                        <span class="stat-value" id="saveCon">+0</span>
                    </div>
                    <div class="stat-compact">
                        <span class="stat-name">Charisma</span>
                        <span class="stat-value" id="saveCha">+0</span>
                    </div>
                </div>

                <div class="card">
                    <h2>Fertigkeiten</h2>
                    <div id="skillsList">
                        <!-- Skills will be loaded here -->
                    </div>
                </div>
            </div>

            <!-- Middle Column: Combat & Features -->
            <div class="middle-column">
                <div class="card">
                    <h2>Trefferpunkte</h2>
                    <div class="hp-tracker">
                        <div class="hp-display" id="currentHP">6</div>
                        <div class="hp-max">/ <span id="maxHP">6</span> TP</div>
                        <div class="hp-controls">
                            <button class="btn btn-small" onclick="adjustHP(1)">+1</button>
                            <button class="btn btn-small" onclick="adjustHP(5)">+5</button>
                            <button class="btn btn-small btn-danger" onclick="adjustHP(-1)">-1</button>
                            <button class="btn btn-small btn-danger" onclick="adjustHP(-5)">-5</button>
                        </div>
                    </div>

                    <div class="rest-section">
                        <button class="btn" onclick="shortRest()">Kurze Rast</button>
                        <button class="btn" onclick="longRest()">Lange Rast</button>
                    </div>
                </div>

                <!-- Arcane Recovery -->
                <div class="card">
                    <div class="arcane-recovery-box">
                        <h3>‚ú® Arkane Erholung</h3>
                        <div class="recovery-info">
                            Zauberpl√§tze bis Stufe <span id="recoveryLevel">3</span> wiedererlangen
                        </div>
                        <div class="recovery-available" id="recoveryStatus">Verf√ºgbar nach kurzer Rast</div>
                        <button class="btn" style="margin-top: 10px;" onclick="useArcaneRecovery()" id="recoveryBtn">
                            Arkane Erholung nutzen
                        </button>
                    </div>
                </div>

                <!-- Spell Slots -->
                <div class="card">
                    <h2>Zauberpl√§tze</h2>
                    <div class="spell-slots-compact" id="spellSlots">
                        <!-- Spell slots will be loaded here -->
                    </div>
                </div>

                <!-- Class Features -->
                <div class="card">
                    <h2>Klassenf√§higkeiten</h2>
                    <div class="feature-list" id="featuresList">
                        <!-- Features will be loaded here -->
                    </div>
                </div>

                <div class="card">
                    <h2>Ausr√ºstung</h2>
                    <div id="equipmentList">
                        <!-- Equipment will be loaded here -->
                    </div>
                    <button class="btn" style="width: 100%; margin-top: 10px;" onclick="showEquipmentBrowser()">
                        üì¶ Ausr√ºstung durchsuchen
                    </button>
                </div>
            </div>

            <!-- Right Column: Spellbook -->
            <div class="right-column">
                <div class="card">
                    <div class="spellbook-header">
                        <h2>üìñ Zauberbuch</h2>
                        <span class="spell-count" id="spellCount">0 Zauber</span>
                    </div>

                    <div class="prepared-count">
                        <div class="prepared-count-text">Vorbereitete Zauber</div>
                        <div class="prepared-count-number">
                            <span id="preparedCount">0</span> / <span id="maxPrepared">0</span>
                        </div>
                    </div>

                    <div class="spell-tabs">
                        <div class="spell-tab active" data-level="all" onclick="filterSpells('all')">Alle</div>
                        <div class="spell-tab" data-level="prepared" onclick="filterSpells('prepared')">Vorbereitet</div>
                        <div class="spell-tab" data-level="0" onclick="filterSpells(0)">Tricks</div>
                        <div class="spell-tab" data-level="1" onclick="filterSpells(1)">1</div>
                        <div class="spell-tab" data-level="2" onclick="filterSpells(2)">2</div>
                        <div class="spell-tab" data-level="3" onclick="filterSpells(3)">3</div>
                        <div class="spell-tab" data-level="4" onclick="filterSpells(4)">4</div>
                        <div class="spell-tab" data-level="5" onclick="filterSpells(5)">5</div>
                    </div>

                    <div class="spells-list" id="spellsList">
                        <!-- Spells will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_URL = 'db_actions.php';
        let characterStats = {};
        let characterId = 1;
        let currentSpellFilter = 'all';
        let preparedSpells = [];
        let arcaneRecoveryUsed = false;

        const skills = {
            'arcana': { name: 'Arkane Kunde', ability: 'int' },
            'history': { name: 'Geschichte', ability: 'int' },
            'insight': { name: 'Motiv erkennen', ability: 'wis' },
            'investigation': { name: 'Nachforschung', ability: 'int' },
            'medicine': { name: 'Heilkunde', ability: 'wis' },
            'religion': { name: 'Religion', ability: 'int' },
            'acrobatics': { name: 'Akrobatik', ability: 'dex' },
            'animal_handling': { name: 'Tierf√ºhrung', ability: 'wis' },
            'athletics': { name: 'Athletik', ability: 'str' },
            'deception': { name: 'T√§uschung', ability: 'cha' },
            'intimidation': { name: 'Einsch√ºchtern', ability: 'cha' },
            'nature': { name: 'Naturkunde', ability: 'int' },
            'perception': { name: 'Wahrnehmung', ability: 'wis' },
            'performance': { name: 'Auftreten', ability: 'cha' },
            'persuasion': { name: '√úberzeugen', ability: 'cha' },
            'sleight_of_hand': { name: 'Fingerfertigkeit', ability: 'dex' },
            'stealth': { name: 'Heimlichkeit', ability: 'dex' },
            'survival': { name: '√úberlebenskunst', ability: 'wis' }
        };

        const spellSlotsByLevel = {
            1: [0, 2, 0, 0, 0, 0, 0, 0, 0, 0],
            2: [0, 3, 0, 0, 0, 0, 0, 0, 0, 0],
            3: [0, 4, 2, 0, 0, 0, 0, 0, 0, 0],
            4: [0, 4, 3, 0, 0, 0, 0, 0, 0, 0],
            5: [0, 4, 3, 2, 0, 0, 0, 0, 0, 0],
            6: [0, 4, 3, 3, 0, 0, 0, 0, 0, 0],
            7: [0, 4, 3, 3, 1, 0, 0, 0, 0, 0],
            8: [0, 4, 3, 3, 2, 0, 0, 0, 0, 0],
            9: [0, 4, 3, 3, 3, 1, 0, 0, 0, 0],
            10: [0, 4, 3, 3, 3, 2, 0, 0, 0, 0],
        };

        async function loadCharacter() {
            try {
                const response = await fetch(`${API_URL}?action=character&class=wizard`);
                const result = await response.json();

                if (result.success && result.data) {
                    const char = result.data;
                    characterStats = char;
                    characterId = char.id;

                    document.getElementById('characterName').textContent = char.name;
                    document.getElementById('characterLevel').textContent = char.level;

                    updateAbilities(char);

                    const profBonus = getProficiencyBonus(char.level);
                    const intMod = Math.floor((char.intelligence - 10) / 2);
                    const spellDC = 8 + profBonus + intMod;
                    const spellAttack = profBonus + intMod;

                    document.getElementById('armorClass').textContent = char.armor_class || 10;
                    document.getElementById('speed').textContent = '9m';
                    document.getElementById('profBonus').textContent = '+' + profBonus;
                    document.getElementById('spellDC').textContent = spellDC;
                    document.getElementById('spellAttack').textContent = '+' + spellAttack;

                    document.getElementById('currentHP').textContent = char.current_hp;
                    document.getElementById('maxHP').textContent = char.max_hp;

                    // Arcane Recovery
                    const recoveryLevel = Math.ceil(char.level / 2);
                    document.getElementById('recoveryLevel').textContent = recoveryLevel;

                    // Max prepared spells
                    const maxPrepared = Math.max(1, intMod + char.level);
                    document.getElementById('maxPrepared').textContent = maxPrepared;

                    preparedSpells = JSON.parse(char.prepared_spells || '[]');

                    loadSkills(char);
                    loadFeatures(char);
                    loadSpellSlots(char);
                    loadSpells(char);
                    loadEquipment(char);
                }
            } catch (error) {
                console.error('Fehler beim Laden des Charakters:', error);
            }
        }

        function updateAbilities(char) {
            const abilities = {
                str: char.strength,
                dex: char.dexterity,
                con: char.constitution,
                int: char.intelligence,
                wis: char.wisdom,
                cha: char.charisma
            };

            Object.entries(abilities).forEach(([key, value]) => {
                document.getElementById(`${key}Value`).textContent = value;
                const modifier = Math.floor((value - 10) / 2);
                const modText = modifier >= 0 ? `+${modifier}` : `${modifier}`;
                document.getElementById(`${key}Mod`).textContent = modText;
            });

            const profBonus = getProficiencyBonus(char.level);
            const saveProficiencies = ['int', 'wis'];

            Object.entries(abilities).forEach(([key, value]) => {
                const modifier = Math.floor((value - 10) / 2);
                const isProficient = saveProficiencies.includes(key);
                const saveBonus = modifier + (isProficient ? profBonus : 0);
                const saveText = saveBonus >= 0 ? `+${saveBonus}` : `${saveBonus}`;
                const saveId = `save${key.charAt(0).toUpperCase() + key.slice(1)}`;
                if (document.getElementById(saveId)) {
                    document.getElementById(saveId).textContent = saveText;
                }
            });

            const dexMod = Math.floor((char.dexterity - 10) / 2);
            document.getElementById('initiative').textContent = dexMod >= 0 ? `+${dexMod}` : `${dexMod}`;
        }

        function loadSkills(char) {
            const skillsList = document.getElementById('skillsList');
            skillsList.innerHTML = '';

            const profBonus = getProficiencyBonus(char.level);
            const proficientSkills = JSON.parse(char.proficient_skills || '[]');

            Object.entries(skills).forEach(([key, skill]) => {
                const abilityMod = Math.floor((characterStats[skill.ability] - 10) / 2);
                const isProficient = proficientSkills.includes(key);

                const bonus = abilityMod + (isProficient ? profBonus : 0);
                const bonusText = bonus >= 0 ? `+${bonus}` : `${bonus}`;

                const div = document.createElement('div');
                div.className = 'stat-compact' + (isProficient ? ' proficient' : '');
                div.innerHTML = `
                    <span class="stat-name">${skill.name}</span>
                    <span class="stat-value">${bonusText}</span>
                `;
                skillsList.appendChild(div);
            });
        }

        async function loadFeatures(char) {
            try {
                const response = await fetch(`${API_URL}?action=class_features&class=wizard&level=${char.level}`);
                const result = await response.json();

                const featuresList = document.getElementById('featuresList');
                featuresList.innerHTML = '';

                if (result.success && result.data) {
                    result.data.forEach(feature => {
                        const div = document.createElement('div');
                        div.className = 'feature-item';
                        div.innerHTML = `
                            <h4>${feature.feature_name_de}</h4>
                            <p>${feature.description_de}</p>
                        `;
                        featuresList.appendChild(div);
                    });
                }
            } catch (error) {
                console.error('Fehler beim Laden der Features:', error);
            }
        }

        function loadSpellSlots(char) {
            const slotsContainer = document.getElementById('spellSlots');
            slotsContainer.innerHTML = '';

            const slots = spellSlotsByLevel[char.level] || spellSlotsByLevel[1];
            const usedSlots = JSON.parse(char.used_spell_slots || '{}');

            for (let level = 1; level <= 9; level++) {
                const maxSlots = slots[level] || 0;
                if (maxSlots === 0) continue;

                const slotDiv = document.createElement('div');
                slotDiv.className = 'slot-compact';

                const circlesHTML = [];
                for (let i = 0; i < maxSlots; i++) {
                    const isUsed = (usedSlots[level] || []).includes(i);
                    circlesHTML.push(`<div class="slot-circle-mini ${isUsed ? 'used' : ''}" onclick="toggleSpellSlot(${level}, ${i})"></div>`);
                }

                slotDiv.innerHTML = `
                    <div class="level">${level}</div>
                    <div class="circles">${circlesHTML.join('')}</div>
                `;
                slotsContainer.appendChild(slotDiv);
            }
        }

        async function loadSpells(char) {
            try {
                const response = await fetch(`${API_URL}?action=spells&class=wizard`);
                const result = await response.json();

                if (result.success) {
                    const knownSpells = JSON.parse(char.known_spells || '[]');
                    const spellsList = document.getElementById('spellsList');
                    spellsList.innerHTML = '';

                    const filteredSpells = result.data.filter(spell => knownSpells.includes(spell.id));
                    document.getElementById('spellCount').textContent = `${filteredSpells.length} Zauber`;

                    filteredSpells.forEach(spell => {
                        const isPrepared = preparedSpells.includes(spell.id);
                        const div = document.createElement('div');
                        div.className = 'spell-compact' + (isPrepared ? ' prepared' : '');
                        div.dataset.level = spell.level;
                        div.dataset.prepared = isPrepared;
                        if (spell.ritual) div.classList.add('ritual');
                        if (spell.concentration) div.classList.add('concentration');

                        div.innerHTML = `
                            <div class="spell-header">
                                <span class="spell-name">
                                    ${spell.name_de}
                                    <span class="spell-level">${spell.level === 0 ? 'Trick' : spell.level}</span>
                                </span>
                                <div class="spell-actions">
                                    ${spell.level > 0 ? `<button class="spell-prepare-btn ${isPrepared ? 'prepared' : ''}" onclick="togglePrepared(event, ${spell.id})">${isPrepared ? '‚úì' : 'Vorb.'}</button>` : ''}
                                </div>
                            </div>
                            <div class="spell-school">${spell.school_de}</div>
                            <div class="spell-details">
                                ${spell.casting_time_de} ‚Ä¢ ${spell.range_de} ‚Ä¢ ${spell.components}
                                ${spell.ritual ? ' ‚Ä¢ <span style="color: #ffd700;">Ritual</span>' : ''}
                                ${spell.concentration ? ' ‚Ä¢ <span style="color: #ff9800;">Konzentration</span>' : ''}
                            </div>
                            <div class="spell-description">${spell.description_de}</div>
                        `;

                        div.onclick = (e) => {
                            if (!e.target.classList.contains('spell-prepare-btn')) {
                                div.classList.toggle('expanded');
                            }
                        };

                        spellsList.appendChild(div);
                    });

                    updatePreparedCount();
                    filterSpells(currentSpellFilter);
                }
            } catch (error) {
                console.error('Fehler beim Laden der Zauber:', error);
            }
        }

        function togglePrepared(event, spellId) {
            event.stopPropagation();
            const index = preparedSpells.indexOf(spellId);
            const intMod = Math.floor((characterStats.intelligence - 10) / 2);
            const maxPrepared = Math.max(1, intMod + characterStats.level);

            if (index > -1) {
                preparedSpells.splice(index, 1);
            } else {
                if (preparedSpells.length >= maxPrepared) {
                    alert(`Du kannst maximal ${maxPrepared} Zauber vorbereiten!`);
                    return;
                }
                preparedSpells.push(spellId);
            }

            savePreparedSpells();
            loadSpells(characterStats);
        }

        async function savePreparedSpells() {
            try {
                const formData = new FormData();
                formData.append('action', 'update_prepared_spells');
                formData.append('character_id', characterId);
                formData.append('prepared_spells', JSON.stringify(preparedSpells));

                await fetch(API_URL, { method: 'POST', body: formData });
            } catch (error) {
                console.error('Fehler beim Speichern vorbereiteter Zauber:', error);
            }
        }

        function updatePreparedCount() {
            document.getElementById('preparedCount').textContent = preparedSpells.length;
        }

        function filterSpells(level) {
            currentSpellFilter = level;
            document.querySelectorAll('.spell-tab').forEach(tab => {
                tab.classList.toggle('active', tab.dataset.level == level);
            });

            const spells = document.querySelectorAll('.spell-compact');
            spells.forEach(spell => {
                if (level === 'all') {
                    spell.style.display = 'block';
                } else if (level === 'prepared') {
                    spell.style.display = spell.dataset.prepared === 'true' ? 'block' : 'none';
                } else {
                    spell.style.display = spell.dataset.level == level ? 'block' : 'none';
                }
            });
        }

        function loadEquipment(char) {
            const equipmentList = document.getElementById('equipmentList');
            equipmentList.innerHTML = '';

            const inventory = JSON.parse(char.inventory || '[]');

            if (inventory.length === 0) {
                equipmentList.innerHTML = '<p style="color: #90caf9; text-align: center;">Keine Ausr√ºstung</p>';
                return;
            }

            inventory.forEach(item => {
                const div = document.createElement('div');
                div.className = 'stat-compact';
                div.innerHTML = `
                    <span class="stat-name">${item.name}</span>
                    <span>${item.quantity || 1}√ó</span>
                `;
                equipmentList.appendChild(div);
            });
        }

        function useArcaneRecovery() {
            if (arcaneRecoveryUsed) {
                alert('Arkane Erholung bereits verwendet! Wird nach langer Rast wiederhergestellt.');
                return;
            }

            const recoveryLevel = Math.ceil(characterStats.level / 2);
            alert(`Arkane Erholung verwendet! Du kannst Zauberpl√§tze bis Gesamtstufe ${recoveryLevel} wiederherstellen.`);
            arcaneRecoveryUsed = true;
            document.getElementById('recoveryStatus').textContent = 'Verwendet';
            document.getElementById('recoveryBtn').disabled = true;
        }

        function toggleSpellSlot(level, index) {
            const circle = event.target;
            circle.classList.toggle('used');
            // TODO: Save to DB
        }

        function getProficiencyBonus(level) {
            return Math.ceil(level / 4) + 1;
        }

        function adjustHP(amount) {
            const current = parseInt(document.getElementById('currentHP').textContent);
            const max = parseInt(document.getElementById('maxHP').textContent);
            const newHP = Math.max(0, Math.min(max, current + amount));
            document.getElementById('currentHP').textContent = newHP;
            updateCharacterHP(newHP);
        }

        async function updateCharacterHP(newHP) {
            try {
                const formData = new FormData();
                formData.append('action', 'update_hp');
                formData.append('character_id', characterId);
                formData.append('current_hp', newHP);
                await fetch(API_URL, { method: 'POST', body: formData });
            } catch (error) {
                console.error('Fehler beim Speichern der HP:', error);
            }
        }

        async function shortRest() {
            if (confirm('Kurze Rast nehmen? (1 Stunde) Du kannst Trefferw√ºrfel verwenden und Arkane Erholung nutzen.')) {
                arcaneRecoveryUsed = false;
                document.getElementById('recoveryStatus').textContent = 'Verf√ºgbar';
                document.getElementById('recoveryBtn').disabled = false;
                alert('Kurze Rast abgeschlossen!');
            }
        }

        async function longRest() {
            if (confirm('Lange Rast nehmen? (8 Stunden) HP und alle Zauberpl√§tze werden wiederhergestellt.')) {
                arcaneRecoveryUsed = false;
                document.getElementById('recoveryStatus').textContent = 'Verf√ºgbar';
                document.getElementById('recoveryBtn').disabled = false;
                try {
                    const response = await fetch(`${API_URL}?action=long_rest&character_id=${characterId}`);
                    const result = await response.json();
                    if (result.success) {
                        alert('Lange Rast abgeschlossen!');
                        loadCharacter();
                    }
                } catch (error) {
                    console.error('Fehler bei langer Rast:', error);
                }
            }
        }

        function showEquipmentTab() {
            alert('Ausr√ºstungsverwaltung wird geladen...');
        }

        function showNotesTab() {
            alert('Notizfunktion wird geladen...');
        }

        function showEquipmentBrowser() {
            alert('Ausr√ºstungs-Browser wird geladen...');
        }

        window.addEventListener('load', () => {
            loadCharacter();
        });
    </script>
</body>
</html>
