<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ausrüstung - Magier Tracker</title>
    <link rel="icon" type="image/svg+xml" href="assets/icons/favicon.svg">
    <link rel="stylesheet" href="assets/css/shared-styles.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #42a5f5 0%, #1976d2 100%);
            color: #e3f2fd;
            min-height: 100vh;
            padding: 20px;
        }

        /* Navigation */
        nav {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        nav a {
            color: #42a5f5;
            text-decoration: none;
            padding: 8px 16px;
            border-radius: 5px;
            transition: all 0.3s;
        }

        nav a:hover {
            background: rgba(165, 214, 167, 0.2);
            color: #bbdefb;
        }

        nav a.active {
            background: #42a5f5;
            color: white;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            margin-bottom: 30px;
            color: #bbdefb;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }

        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .section {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }

        .section h2 {
            color: #42a5f5;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #42a5f5;
        }

        /* Equipped Items */
        .equipment-slots {
            display: grid;
            gap: 15px;
        }

        .equipment-slot {
            background: rgba(76, 175, 80, 0.1);
            border: 2px solid #42a5f5;
            border-radius: 10px;
            padding: 15px;
        }

        .equipment-slot.empty {
            border-style: dashed;
            opacity: 0.6;
        }

        .slot-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .slot-name {
            color: #42a5f5;
            font-weight: 600;
            font-size: 14px;
        }

        .item-name {
            color: #bbdefb;
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 8px;
        }

        .item-details {
            color: #42a5f5;
            font-size: 14px;
            line-height: 1.6;
        }

        .btn-unequip {
            padding: 6px 12px;
            background: #e57373;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s;
        }

        .btn-unequip:hover {
            background: #ef5350;
        }

        /* Inventory */
        .inventory-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .search-box {
            flex: 1;
            padding: 10px;
            border-radius: 5px;
            border: 2px solid #42a5f5;
            background: rgba(255, 255, 255, 0.1);
            color: #e3f2fd;
        }

        .btn-add {
            padding: 10px 20px;
            background: #42a5f5;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }

        .btn-add:hover {
            background: #45a049;
        }

        .inventory-grid {
            display: grid;
            gap: 10px;
            max-height: 600px;
            overflow-y: auto;
        }

        .inventory-item {
            background: rgba(76, 175, 80, 0.1);
            border: 2px solid #42a5f5;
            border-radius: 8px;
            padding: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s;
        }

        .inventory-item:hover {
            background: rgba(76, 175, 80, 0.15);
        }

        .item-info {
            flex: 1;
        }

        .item-info-name {
            color: #bbdefb;
            font-weight: bold;
            margin-bottom: 4px;
        }

        .item-info-type {
            color: #42a5f5;
            font-size: 13px;
        }

        .item-info-description {
            color: #90caf9;
            font-size: 12px;
            margin-top: 4px;
            font-style: italic;
            line-height: 1.4;
        }

        .item-actions {
            display: flex;
            gap: 8px;
        }

        .btn-equip {
            padding: 6px 12px;
            background: #42a5f5;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s;
        }

        .btn-equip:hover {
            background: #45a049;
        }

        .btn-remove {
            padding: 6px 12px;
            background: #e57373;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s;
        }

        .btn-remove:hover {
            background: #ef5350;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: #2d5016;
            border-radius: 15px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h2 {
            color: #bbdefb;
        }

        .btn-close {
            background: none;
            border: none;
            color: #e3f2fd;
            font-size: 24px;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            color: #bbdefb;
            margin-bottom: 5px;
            font-weight: 600;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border-radius: 5px;
            border: 2px solid #42a5f5;
            background: rgba(255, 255, 255, 0.1);
            color: #e3f2fd;
            font-size: 14px;
        }

        .form-group textarea {
            min-height: 80px;
            resize: vertical;
        }

        .btn-submit {
            width: 100%;
            padding: 12px;
            background: #42a5f5;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-submit:hover {
            background: #45a049;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: rgba(76, 175, 80, 0.1);
            border-radius: 5px;
            margin-bottom: 10px;
        }

        .checkbox-group input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .checkbox-group label {
            margin: 0;
            cursor: pointer;
            flex: 1;
            color: #bbdefb;
        }

        .conditional-fields {
            display: none;
            margin-top: 10px;
            padding: 15px;
            background: rgba(76, 175, 80, 0.05);
            border-radius: 5px;
            border-left: 3px solid #42a5f5;
        }

        .conditional-fields.show {
            display: block;
        }

        /* Save Section */
        .save-section {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 20px;
            text-align: center;
        }

        .btn-save {
            padding: 12px 32px;
            background: #42a5f5;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-save:hover {
            background: #45a049;
            transform: translateY(-2px);
        }

        .btn-back {
            padding: 12px 32px;
            background: #757575;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            margin-left: 15px;
        }

        .btn-back:hover {
            background: #616161;
        }

        .save-indicator {
            margin-top: 15px;
            padding: 10px;
            border-radius: 5px;
            display: none;
        }

        .save-indicator.success {
            background: rgba(76, 175, 80, 0.3);
            color: #bbdefb;
            display: block;
        }

        .save-indicator.error {
            background: rgba(229, 115, 115, 0.3);
            color: #ffcdd2;
            display: block;
        }

        @media (max-width: 1024px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            nav {
                flex-direction: column;
                gap: 10px;
            }

            .container {
                padding: 15px;
            }

            h1 {
                font-size: 1.5em;
                margin-bottom: 20px;
            }

            .section {
                padding: 15px;
            }

            .equipment-slot {
                padding: 12px;
            }

            .inventory-controls {
                flex-direction: column;
            }

            .btn-add {
                width: 100%;
            }

            .inventory-item {
                flex-direction: column;
                gap: 10px;
            }

            .item-actions {
                width: 100%;
                justify-content: space-between;
            }

            .btn-save, .btn-back {
                font-size: 16px;
                padding: 10px 20px;
            }

            .modal-content {
                width: 95%;
                padding: 20px;
            }
        }

        @media (max-width: 480px) {
            .btn-save, .btn-back {
                display: block;
                width: 100%;
                margin-left: 0;
                margin-top: 10px;
            }

            .item-actions {
                flex-direction: column;
                gap: 8px;
            }

            .item-actions button {
                width: 100%;
            }
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #42a5f5;
            font-size: 16px;
            opacity: 0.7;
        }

        /* Database Search Dropdown */
        .search-wrapper {
            position: relative;
            flex: 1;
        }

        .search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: rgba(29, 60, 16, 0.98);
            border: 2px solid #42a5f5;
            border-top: none;
            border-radius: 0 0 5px 5px;
            max-height: 300px;
            overflow-y: auto;
            z-index: 100;
            display: none;
        }

        .search-results.active {
            display: block;
        }

        .search-result-item {
            padding: 12px;
            border-bottom: 1px solid rgba(76, 175, 80, 0.2);
            cursor: pointer;
            transition: all 0.3s;
        }

        .search-result-item:last-child {
            border-bottom: none;
        }

        .search-result-item:hover {
            background: rgba(76, 175, 80, 0.2);
        }

        .search-result-name {
            color: #bbdefb;
            font-weight: bold;
            margin-bottom: 4px;
        }

        .search-result-details {
            color: #42a5f5;
            font-size: 12px;
        }

        .search-loading {
            padding: 15px;
            text-align: center;
            color: #42a5f5;
        }

        .search-mode-toggle {
            display: flex;
            gap: 5px;
            margin-bottom: 10px;
        }

        .search-mode-btn {
            flex: 1;
            padding: 8px;
            background: rgba(76, 175, 80, 0.1);
            border: 2px solid #42a5f5;
            color: #42a5f5;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 13px;
        }

        .search-mode-btn.active {
            background: #42a5f5;
            color: white;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(255,255,255,0.3);
            border-top-color: #fff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .notification {
            padding: 15px 20px;
            margin-bottom: 10px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            animation: slideIn 0.3s ease;
            max-width: 300px;
        }

        .notification.success { background: #4CAF50; }
        .notification.error { background: #f44336; }
        .notification.warning { background: #ff9800; }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
    </style>
</head>
<body>
    <div id="notification-container" style="position: fixed; top: 20px; right: 20px; z-index: 1000;"></div>
    <div id="loading-overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 999; justify-content: center; align-items: center;">
        <div class="loading-spinner"></div>
    </div>

    <nav>
        <a href="dashboard-wizard.html">Dashboard</a>
        <a href="character-wizard.html">Charakter</a>
        <a href="spells-wizard.html">Zauber</a>
        <a href="equipment-wizard.html" class="active">Ausrüstung</a>
    </nav>

    <div class="container">
        <h1>Ausrüstung verwalten</h1>

        <div class="main-grid">
            <!-- Equipped Items -->
            <div class="section">
                <h2>Ausgerüstete Gegenstände</h2>
                <div class="equipment-slots" id="equippedSlots">
                    <div class="equipment-slot empty">
                        <div class="slot-header">
                            <span class="slot-name">Waffe (Haupthand)</span>
                        </div>
                        <div class="empty-state">Kein Gegenstand ausgerüstet</div>
                    </div>
                    <div class="equipment-slot empty">
                        <div class="slot-header">
                            <span class="slot-name">Waffe (Nebenhand) / Schild</span>
                        </div>
                        <div class="empty-state">Kein Gegenstand ausgerüstet</div>
                    </div>
                    <div class="equipment-slot empty">
                        <div class="slot-header">
                            <span class="slot-name">Rüstung</span>
                        </div>
                        <div class="empty-state">Kein Gegenstand ausgerüstet</div>
                    </div>
                    <div class="equipment-slot empty">
                        <div class="slot-header">
                            <span class="slot-name">Magisches Objekt</span>
                        </div>
                        <div class="empty-state">Kein Gegenstand ausgerüstet</div>
                    </div>
                </div>
            </div>

            <!-- Inventory -->
            <div class="section">
                <h2>Inventar</h2>
                <div class="search-mode-toggle">
                    <button class="search-mode-btn" id="btnInventoryMode" onclick="setSearchMode('inventory')">Inventar durchsuchen</button>
                    <button class="search-mode-btn active" id="btnDatabaseMode" onclick="setSearchMode('database')">Datenbank durchsuchen</button>
                </div>
                <div class="inventory-controls">
                    <div class="search-wrapper">
                        <input type="text" class="search-box" id="searchBox" placeholder="Gegenstand in Datenbank suchen..." oninput="handleSearch()">
                        <div class="search-results" id="searchResults"></div>
                    </div>
                    <button class="btn-add" onclick="openAddItemModal()">+ Manuell hinzufügen</button>
                </div>
                <div class="inventory-grid" id="inventoryGrid">
                    <div class="empty-state">Keine Gegenstände im Inventar</div>
                </div>
            </div>
        </div>

        <!-- Save Section -->
        <div class="save-section">
            <button class="btn-save" onclick="saveInventory(true)">Änderungen speichern</button>
            <button class="btn-back" onclick="goBack()">Zurück zum Dashboard</button>
            <div class="save-indicator" id="saveIndicator"></div>
        </div>
    </div>

    <!-- Add Item Modal -->
    <div class="modal" id="addItemModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Gegenstand hinzufügen</h2>
                <button class="btn-close" onclick="closeAddItemModal()">&times;</button>
            </div>
            <form onsubmit="addCustomItem(event)">
                <div class="form-group">
                    <label>Name</label>
                    <input type="text" id="itemName" required>
                </div>
                <div class="form-group">
                    <label>Typ</label>
                    <select id="itemType" required onchange="toggleItemFields()">
                        <option value="">Bitte wählen...</option>
                        <option value="weapon">Waffe</option>
                        <option value="armor">Rüstung</option>
                        <option value="shield">Schild</option>
                        <option value="magic">Magisches Objekt</option>
                        <option value="tool">Werkzeug</option>
                        <option value="consumable">Verbrauchsgegenstand</option>
                        <option value="misc">Sonstiges</option>
                    </select>
                </div>

                <!-- Weapon-specific fields -->
                <div id="weaponFields" class="conditional-fields">
                    <div class="form-group">
                        <label>Schadenswürfel (z.B. 1d6, 1d8+2)</label>
                        <input type="text" id="weaponDamageDice" placeholder="1d6">
                    </div>
                    <div class="form-group">
                        <label>Schadensart</label>
                        <select id="weaponDamageType">
                            <option value="">Bitte wählen...</option>
                            <option value="Hieb">Hieb</option>
                            <option value="Stich">Stich</option>
                            <option value="Wucht">Wucht</option>
                            <option value="Feuer">Feuer</option>
                            <option value="Kälte">Kälte</option>
                            <option value="Blitz">Blitz</option>
                            <option value="Gift">Gift</option>
                            <option value="Säure">Säure</option>
                        </select>
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="weaponProficient" checked>
                        <label for="weaponProficient">Geübt mit dieser Waffe</label>
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="weaponFinesse">
                        <label for="weaponFinesse">Finesse-Waffe (nutzt höheren Wert: STR oder GES)</label>
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="weaponRanged">
                        <label for="weaponRanged">Fernkampfwaffe (nutzt GES)</label>
                    </div>
                </div>

                <!-- Armor-specific fields -->
                <div id="armorFields" class="conditional-fields">
                    <div class="form-group">
                        <label>Rüstungsklasse (AC)</label>
                        <input type="number" id="armorAC" min="10" max="30" value="13">
                    </div>
                    <div class="form-group">
                        <label>AC Berechnung</label>
                        <select id="armorACType">
                            <option value="fixed">Fester Wert (z.B. Plattenrüstung: 18)</option>
                            <option value="dex">Fester Wert + GES Mod (z.B. Lederrüstung: 11 + GES)</option>
                            <option value="dex_max2">Fester Wert + GES Mod (max +2) (z.B. Brustpanzer: 14 + GES, max +2)</option>
                        </select>
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="armorStealth">
                        <label for="armorStealth">Nachteil auf Heimlichkeit</label>
                    </div>
                </div>

                <!-- Shield-specific fields -->
                <div id="shieldFields" class="conditional-fields">
                    <div class="form-group">
                        <label>AC Bonus</label>
                        <input type="number" id="shieldACBonus" min="0" max="5" value="2">
                    </div>
                </div>

                <div class="form-group">
                    <label>Beschreibung</label>
                    <textarea id="itemDescription"></textarea>
                </div>
                <div class="form-group">
                    <label>Gewicht (Pfund)</label>
                    <input type="number" id="itemWeight" step="0.1" value="1">
                </div>
                <button type="submit" class="btn-submit">Hinzufügen</button>
            </form>
        </div>
    </div>

    <script>
        const API_URL = 'db_actions.php';
        const CHARACTER_ID = new URLSearchParams(window.location.search).get('id') || 1;

        function showNotification(message, type = 'success') {
            const container = document.getElementById('notification-container');
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            container.appendChild(notification);
            setTimeout(() => notification.remove(), 3000);
        }

        function showLoading() {
            document.getElementById('loading-overlay').style.display = 'flex';
        }

        function hideLoading() {
            document.getElementById('loading-overlay').style.display = 'none';
        }

        let inventory = [];
        let equippedItems = {
            mainhand: null,
            offhand: null,
            armor: null,
            magic: null
        };

        let characterStats = {
            dexterity: 10
        };

        let searchMode = 'database'; // 'database' or 'inventory'
        let searchTimeout = null;

        window.addEventListener('DOMContentLoaded', loadInventoryData);

        // Close search results when clicking outside
        document.addEventListener('click', function(event) {
            const searchWrapper = document.querySelector('.search-wrapper');
            const searchResults = document.getElementById('searchResults');

            if (searchWrapper && !searchWrapper.contains(event.target)) {
                searchResults.classList.remove('active');
            }
        });

        async function loadInventoryData() {
            try {
                showLoading();

                // Load character stats for AC calculation
                const charResponse = await fetch(`${API_URL}?action=character&id=${CHARACTER_ID}`);
                const charData = await charResponse.json();

                if (charData.success && charData.data) {
                    characterStats.dexterity = charData.data.dexterity || 10;
                }

                // Load inventory
                const response = await fetch(`${API_URL}?action=inventory&char_id=${CHARACTER_ID}`);
                const data = await response.json();

                console.log('Loaded inventory data:', data);

                if (data.success) {
                    inventory = data.data.inventory || [];
                    equippedItems = data.data.equipped || {
                        mainhand: null,
                        offhand: null,
                        armor: null,
                        magic: null
                    };

                    console.log('Inventory items:', inventory);
                    console.log('Equipped items:', equippedItems);

                    renderEquippedItems();
                    renderInventory();
                } else {
                    throw new Error(data.error || 'Inventar konnte nicht geladen werden');
                }
            } catch (error) {
                console.error('Error loading inventory:', error);
                showNotification(error.message || 'Fehler beim Laden des Inventars', 'error');
            } finally {
                hideLoading();
            }
        }

        function renderEquippedItems() {
            const slots = document.getElementById('equippedSlots');
            const slotNames = {
                mainhand: 'Waffe (Haupthand)',
                offhand: 'Waffe (Nebenhand) / Schild',
                armor: 'Rüstung',
                magic: 'Magisches Objekt'
            };

            slots.innerHTML = Object.entries(slotNames).map(([slot, name]) => {
                const item = equippedItems[slot];

                if (item) {
                    let details = item.description || 'Keine Beschreibung';

                    // Add weapon-specific details
                    if (item.type === 'weapon') {
                        details += `<br><strong>Schaden:</strong> ${item.damage_dice || '1d6'}`;
                        if (item.damage_type) details += ` ${item.damage_type}`;
                        const props = [];
                        if (item.proficient) props.push('Geübt');
                        if (item.finesse) props.push('Finesse');
                        if (item.ranged) props.push('Fernkampf');
                        if (props.length > 0) details += `<br><strong>Eigenschaften:</strong> ${props.join(', ')}`;
                    }

                    // Add armor-specific details
                    if (item.type === 'armor') {
                        details += `<br><strong>AC:</strong> ${item.ac || 10}`;
                        if (item.ac_type === 'dex') details += ' + GES';
                        if (item.ac_type === 'dex_max2') details += ' + GES (max +2)';
                        if (item.stealth_disadvantage) details += `<br><strong>Nachteil auf Heimlichkeit</strong>`;
                    }

                    // Add shield-specific details
                    if (item.type === 'shield') {
                        details += `<br><strong>AC Bonus:</strong> +${item.ac_bonus || 2}`;
                    }

                    if (item.weight) details += `<br><strong>Gewicht:</strong> ${item.weight} Pfund`;

                    return `
                        <div class="equipment-slot">
                            <div class="slot-header">
                                <span class="slot-name">${name}</span>
                                <button class="btn-unequip" onclick="unequipItem('${slot}')">Ablegen</button>
                            </div>
                            <div class="item-name">${item.name}</div>
                            <div class="item-details">${details}</div>
                        </div>
                    `;
                } else {
                    return `
                        <div class="equipment-slot empty">
                            <div class="slot-header">
                                <span class="slot-name">${name}</span>
                            </div>
                            <div class="empty-state">Kein Gegenstand ausgerüstet</div>
                        </div>
                    `;
                }
            }).join('');
        }

        function renderInventory() {
            const grid = document.getElementById('inventoryGrid');

            if (inventory.length === 0) {
                grid.innerHTML = '<div class="empty-state">Keine Gegenstände im Inventar</div>';
                return;
            }

            grid.innerHTML = inventory.map((item, index) => {
                const canEquip = ['weapon', 'armor', 'shield', 'magic'].includes(item.type);

                // Build item details/description
                let details = [];
                if (item.description) details.push(item.description);
                if (item.type === 'weapon' && item.damage_dice) {
                    details.push(`Schaden: ${item.damage_dice}${item.damage_type ? ' ' + item.damage_type : ''}`);
                }
                if (item.type === 'armor' && item.ac) {
                    details.push(`RK: ${item.ac}`);
                }
                if (item.type === 'shield' && item.ac_bonus) {
                    details.push(`RK Bonus: +${item.ac_bonus}`);
                }

                return `
                    <div class="inventory-item">
                        <div class="item-info">
                            <div class="item-info-name">${item.name}</div>
                            <div class="item-info-type">${getTypeLabel(item.type)}${item.weight ? ` • ${item.weight} Pfund` : ''}</div>
                            ${details.length > 0 ? `<div class="item-info-description">${details.join(' • ')}</div>` : ''}
                        </div>
                        <div class="item-actions">
                            ${canEquip ? `<button class="btn-equip" onclick="equipItem(${index})">Ausrüsten</button>` : ''}
                            <button class="btn-remove" onclick="removeFromInventory(${index})">Entfernen</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function setSearchMode(mode) {
            searchMode = mode;

            // Update button states
            document.getElementById('btnInventoryMode').classList.toggle('active', mode === 'inventory');
            document.getElementById('btnDatabaseMode').classList.toggle('active', mode === 'database');

            // Update search placeholder
            const searchBox = document.getElementById('searchBox');
            if (mode === 'database') {
                searchBox.placeholder = 'Gegenstand in Datenbank suchen...';
            } else {
                searchBox.placeholder = 'Inventar durchsuchen...';
            }

            // Clear search and results
            searchBox.value = '';
            document.getElementById('searchResults').classList.remove('active');

            // Re-render inventory
            if (mode === 'inventory') {
                renderInventory();
            }
        }

        function handleSearch() {
            const searchTerm = document.getElementById('searchBox').value.trim();

            if (searchMode === 'database') {
                // Debounce database search
                clearTimeout(searchTimeout);

                if (searchTerm.length < 2) {
                    document.getElementById('searchResults').classList.remove('active');
                    return;
                }

                searchTimeout = setTimeout(() => {
                    searchDatabaseEquipment(searchTerm);
                }, 300);
            } else {
                // Instant inventory filter
                filterInventory();
            }
        }

        async function searchDatabaseEquipment(searchTerm) {
            const searchResults = document.getElementById('searchResults');

            try {
                // Show loading state
                searchResults.innerHTML = '<div class="search-loading">Suche...</div>';
                searchResults.classList.add('active');

                const response = await fetch(`${API_URL}?action=equipment&search=${encodeURIComponent(searchTerm)}`);
                const data = await response.json();

                if (data.success && data.data.length > 0) {
                    searchResults.innerHTML = data.data.map(item => {
                        let details = getTypeLabel(item.type);

                        // Add weapon details
                        if (item.type === 'weapon' && item.damage_dice) {
                            details += ` • ${item.damage_dice} ${item.damage_type || ''}`;
                        }

                        // Add armor details
                        if (item.type === 'armor' && item.armor_class) {
                            details += ` • AC ${item.armor_class}`;
                        }

                        // Add weight if available
                        if (item.weight_lbs) {
                            details += ` • ${item.weight_lbs} Pfund`;
                        }

                        return `
                            <div class="search-result-item" onclick='selectDatabaseItem(${JSON.stringify(item).replace(/'/g, "&apos;")})'>
                                <div class="search-result-name">${item.name_de}</div>
                                <div class="search-result-details">${details}</div>
                            </div>
                        `;
                    }).join('');
                } else {
                    searchResults.innerHTML = '<div class="search-loading">Keine Ergebnisse gefunden</div>';
                }
            } catch (error) {
                console.error('Error searching database:', error);
                searchResults.innerHTML = '<div class="search-loading">Fehler bei der Suche</div>';
            }
        }

        function selectDatabaseItem(dbItem) {
            // Close search results
            document.getElementById('searchResults').classList.remove('active');
            document.getElementById('searchBox').value = '';

            // Map database item to inventory item format
            const newItem = {
                name: dbItem.name_de,
                type: dbItem.type,
                description: dbItem.description_de || '',
                weight: parseFloat(dbItem.weight_lbs) || 1,
                quantity: isStackable(dbItem.type) ? 1 : undefined
            };

            // Add weapon-specific fields
            if (dbItem.type === 'weapon') {
                newItem.damage_dice = dbItem.damage_dice || '1d6';
                newItem.damage_type = dbItem.damage_type || '';
                newItem.proficient = true; // Default to proficient

                // Parse properties from JSON
                let properties = {};
                try {
                    properties = typeof dbItem.properties === 'string'
                        ? JSON.parse(dbItem.properties)
                        : (dbItem.properties || {});
                } catch (e) {
                    console.warn('Could not parse properties:', e);
                }

                newItem.finesse = properties.finesse || false;
                newItem.ranged = properties.ranged || false;
            }

            // Add armor-specific fields
            if (dbItem.type === 'armor') {
                newItem.ac = parseInt(dbItem.armor_class) || 13;

                // Parse properties from JSON to get armor_type
                let properties = {};
                try {
                    properties = typeof dbItem.properties === 'string'
                        ? JSON.parse(dbItem.properties)
                        : (dbItem.properties || {});
                } catch (e) {
                    console.warn('Could not parse properties:', e);
                }

                newItem.ac_type = properties.armor_type === 'light' ? 'dex' :
                                 properties.armor_type === 'medium' ? 'dex_max2' : 'fixed';
                newItem.stealth_disadvantage = properties.stealth_disadvantage || false;
            }

            // Add shield-specific fields
            if (dbItem.type === 'shield') {
                newItem.ac_bonus = parseInt(dbItem.armor_class) || 2;
            }

            // Add to inventory
            inventory.push(newItem);

            // Save and render
            saveInventory();
            renderInventory();

            // Show success message
            showNotification(`${newItem.name} wurde zum Inventar hinzugefügt!`, 'success');
        }

        function filterInventory() {
            const searchTerm = document.getElementById('searchBox').value.toLowerCase();
            const grid = document.getElementById('inventoryGrid');

            const filtered = inventory.filter(item =>
                item.name.toLowerCase().includes(searchTerm) ||
                (item.description && item.description.toLowerCase().includes(searchTerm))
            );

            if (filtered.length === 0) {
                grid.innerHTML = '<div class="empty-state">Keine passenden Gegenstände gefunden</div>';
                return;
            }

            grid.innerHTML = filtered.map((item) => {
                const index = inventory.indexOf(item);
                const canEquip = ['weapon', 'armor', 'shield', 'magic'].includes(item.type);

                // Build item details/description
                let details = [];
                if (item.description) details.push(item.description);
                if (item.type === 'weapon' && item.damage_dice) {
                    details.push(`Schaden: ${item.damage_dice}${item.damage_type ? ' ' + item.damage_type : ''}`);
                }
                if (item.type === 'armor' && item.ac) {
                    details.push(`RK: ${item.ac}`);
                }
                if (item.type === 'shield' && item.ac_bonus) {
                    details.push(`RK Bonus: +${item.ac_bonus}`);
                }

                return `
                    <div class="inventory-item">
                        <div class="item-info">
                            <div class="item-info-name">${item.name}</div>
                            <div class="item-info-type">${getTypeLabel(item.type)}${item.weight ? ` • ${item.weight} Pfund` : ''}</div>
                            ${details.length > 0 ? `<div class="item-info-description">${details.join(' • ')}</div>` : ''}
                        </div>
                        <div class="item-actions">
                            ${canEquip ? `<button class="btn-equip" onclick="equipItem(${index})">Ausrüsten</button>` : ''}
                            <button class="btn-remove" onclick="removeFromInventory(${index})">Entfernen</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function equipItem(index) {
            const item = inventory[index];

            // Determine which slot to use
            let slot;
            if (item.type === 'weapon') {
                slot = equippedItems.mainhand ? 'offhand' : 'mainhand';
            } else if (item.type === 'shield') {
                slot = 'offhand';
            } else if (item.type === 'armor') {
                slot = 'armor';
            } else if (item.type === 'magic') {
                slot = 'magic';
            }

            // If slot is occupied, move old item back to inventory
            if (equippedItems[slot]) {
                inventory.push(equippedItems[slot]);
            }

            // Equip new item
            equippedItems[slot] = item;

            // Remove from inventory
            inventory.splice(index, 1);

            // If equipping a weapon to mainhand, update character's equipped_weapon
            if (item.type === 'weapon' && slot === 'mainhand') {
                await updateEquippedWeapon(item);
            }

            // If equipping armor or shield, update character's AC
            if (item.type === 'armor' || item.type === 'shield') {
                await updateCharacterAC();
            }

            // Save inventory and equipped items to database
            await saveInventory();

            renderEquippedItems();
            renderInventory();
        }

        async function updateEquippedWeapon(weapon) {
            try {
                const response = await fetch(`${API_URL}?action=update_equipped_weapon`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        char_id: CHARACTER_ID,
                        equipped_weapon: {
                            name: weapon.name,
                            damage_dice: weapon.damage_dice || '1d6',
                            damage_type: weapon.damage_type || '',
                            proficient: weapon.proficient !== false,
                            finesse: weapon.finesse || false,
                            ranged: weapon.ranged || false
                        }
                    })
                });

                const data = await response.json();
                if (data.success) {
                    console.log('Weapon equipped successfully');
                }
            } catch (error) {
                console.error('Error equipping weapon:', error);
            }
        }

        function calculateModifier(abilityScore) {
            return Math.floor((abilityScore - 10) / 2);
        }

        async function updateCharacterAC() {
            // Calculate AC based on equipped armor, shield, and DEX modifier
            try {
                let calculatedAC = 10;
                const dexMod = calculateModifier(characterStats.dexterity);

                // Parse armor properties if armor is equipped
                const armor = equippedItems.armor;
                if (armor && armor.properties) {
                    const props = typeof armor.properties === 'string'
                        ? JSON.parse(armor.properties)
                        : armor.properties;

                    const armorType = props.armor_type; // 'light', 'medium', 'heavy'
                    const armorAC = armor.armor_class || armor.ac || 10;

                    if (armorType === 'light') {
                        // Light armor: AC + full DEX modifier
                        calculatedAC = armorAC + dexMod;
                    } else if (armorType === 'medium') {
                        // Medium armor: AC + DEX modifier (max +2)
                        calculatedAC = armorAC + Math.min(dexMod, 2);
                    } else if (armorType === 'heavy') {
                        // Heavy armor: AC only (no DEX)
                        calculatedAC = armorAC;
                    } else {
                        // Fallback
                        calculatedAC = armorAC + dexMod;
                    }
                } else {
                    // No armor: 10 + DEX modifier
                    calculatedAC = 10 + dexMod;
                }

                // Add shield bonus
                const shield = equippedItems.offhand;
                if (shield && shield.type === 'shield') {
                    const shieldBonus = shield.armor_class || shield.ac_bonus || 2;
                    calculatedAC += shieldBonus;
                }

                console.log(`AC Calculation: Base=${armor ? armor.armor_class || armor.ac : 10}, DEX Mod=${dexMod}, Shield=${shield ? (shield.armor_class || shield.ac_bonus || 2) : 0}, Total=${calculatedAC}`);

                // Update character AC in database
                const response = await fetch(`${API_URL}?action=update_character_ac`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        char_id: CHARACTER_ID,
                        armor_class: calculatedAC
                    })
                });

                const data = await response.json();
                if (data.success) {
                    console.log('AC updated successfully to:', calculatedAC);
                    showNotification(`Rüstungsklasse aktualisiert: ${calculatedAC}`, 'success');
                }
            } catch (error) {
                console.error('Error updating AC:', error);
                showNotification('Fehler beim Aktualisieren der Rüstungsklasse', 'error');
            }
        }

        async function unequipItem(slot) {
            const item = equippedItems[slot];

            if (item) {
                inventory.push(item);
                equippedItems[slot] = null;

                // If unequipping armor or shield, update character's AC
                if (item.type === 'armor' || item.type === 'shield') {
                    await updateCharacterAC();
                }

                // Save to database
                await saveInventory();

                renderEquippedItems();
                renderInventory();
            }
        }

        async function removeFromInventory(index) {
            if (confirm('Möchtest du diesen Gegenstand wirklich entfernen?')) {
                inventory.splice(index, 1);

                // Save to database
                await saveInventory();

                renderInventory();
            }
        }

        function toggleItemFields() {
            const itemType = document.getElementById('itemType').value;

            // Hide all conditional fields
            document.getElementById('weaponFields').classList.remove('show');
            document.getElementById('armorFields').classList.remove('show');
            document.getElementById('shieldFields').classList.remove('show');

            // Show relevant fields based on type
            if (itemType === 'weapon') {
                document.getElementById('weaponFields').classList.add('show');
            } else if (itemType === 'armor') {
                document.getElementById('armorFields').classList.add('show');
            } else if (itemType === 'shield') {
                document.getElementById('shieldFields').classList.add('show');
            }
        }

        function openAddItemModal() {
            document.getElementById('addItemModal').classList.add('active');
            toggleItemFields();
        }

        function closeAddItemModal() {
            document.getElementById('addItemModal').classList.remove('active');

            // Reset form
            document.getElementById('itemName').value = '';
            document.getElementById('itemType').value = '';
            document.getElementById('itemDescription').value = '';
            document.getElementById('itemWeight').value = '1';

            // Reset weapon fields
            document.getElementById('weaponDamageDice').value = '';
            document.getElementById('weaponDamageType').value = '';
            document.getElementById('weaponProficient').checked = true;
            document.getElementById('weaponFinesse').checked = false;
            document.getElementById('weaponRanged').checked = false;

            // Reset armor fields
            document.getElementById('armorAC').value = '13';
            document.getElementById('armorACType').value = 'fixed';
            document.getElementById('armorStealth').checked = false;

            // Reset shield fields
            document.getElementById('shieldACBonus').value = '2';

            // Hide all conditional fields
            toggleItemFields();
        }

        function addCustomItem(event) {
            event.preventDefault();

            const itemType = document.getElementById('itemType').value;

            const newItem = {
                name: document.getElementById('itemName').value,
                type: itemType,
                description: document.getElementById('itemDescription').value,
                weight: parseFloat(document.getElementById('itemWeight').value),
                quantity: isStackable(itemType) ? 1 : undefined
            };

            // Add type-specific properties
            if (itemType === 'weapon') {
                newItem.damage_dice = document.getElementById('weaponDamageDice').value || '1d6';
                newItem.damage_type = document.getElementById('weaponDamageType').value || '';
                newItem.proficient = document.getElementById('weaponProficient').checked;
                newItem.finesse = document.getElementById('weaponFinesse').checked;
                newItem.ranged = document.getElementById('weaponRanged').checked;
            } else if (itemType === 'armor') {
                newItem.ac = parseInt(document.getElementById('armorAC').value) || 13;
                newItem.ac_type = document.getElementById('armorACType').value || 'fixed';
                newItem.stealth_disadvantage = document.getElementById('armorStealth').checked;
            } else if (itemType === 'shield') {
                newItem.ac_bonus = parseInt(document.getElementById('shieldACBonus').value) || 2;
            }

            inventory.push(newItem);

            // Save to database
            saveInventory();

            renderInventory();
            closeAddItemModal();
        }

        async function saveInventory(showMessage = false) {
            try {
                if (showMessage) showLoading();
                // Ensure equippedItems is always an object, not an array
                const equippedToSave = {
                    mainhand: equippedItems.mainhand || null,
                    offhand: equippedItems.offhand || null,
                    armor: equippedItems.armor || null,
                    magic: equippedItems.magic || null
                };

                const saveData = {
                    char_id: CHARACTER_ID,
                    inventory: inventory || [],
                    equipped_items: equippedToSave
                };

                console.log('Saving inventory:', saveData);
                console.log('Equipped items structure:', equippedToSave);

                const response = await fetch(`${API_URL}?action=update_inventory`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(saveData)
                });

                const data = await response.json();

                console.log('Save response:', data);

                if (showMessage) {
                    if (data.success) {
                        showNotification('Inventar erfolgreich gespeichert!');
                    } else {
                        throw new Error(data.error || 'Fehler beim Speichern');
                    }
                }

                return data.success;
            } catch (error) {
                console.error('Error saving inventory:', error);
                if (showMessage) {
                    showNotification(error.message || 'Fehler beim Speichern', 'error');
                }
                return false;
            } finally {
                if (showMessage) hideLoading();
            }
        }

        function showSaveIndicator(message, type) {
            const indicator = document.getElementById('saveIndicator');
            indicator.textContent = message;
            indicator.className = `save-indicator ${type}`;

            setTimeout(() => {
                indicator.style.display = 'none';
            }, 3000);
        }

        function goBack() {
            window.location.href = 'dashboard-wizard.html';
        }

        function getTypeLabel(type) {
            const labels = {
                weapon: 'Waffe',
                armor: 'Rüstung',
                shield: 'Schild',
                magic: 'Magisches Objekt',
                tool: 'Werkzeug',
                consumable: 'Verbrauchsgegenstand',
                misc: 'Sonstiges'
            };
            return labels[type] || type;
        }

        // Check if an item type is stackable
        function isStackable(type) {
            return ['consumable', 'tool', 'misc'].includes(type);
        }

        // Change the quantity of a stackable item
        function changeQuantity(index, delta) {
            const item = inventory[index];

            if (!item || item.quantity === undefined) {
                console.warn('Item is not stackable or does not exist');
                return;
            }

            // Calculate new quantity
            const newQuantity = item.quantity + delta;

            // Remove item if quantity reaches 0
            if (newQuantity <= 0) {
                if (confirm(`${item.name} auf 0 reduziert. Aus dem Inventar entfernen?`)) {
                    inventory.splice(index, 1);
                    saveInventory();
                    renderInventory();
                }
                return;
            }

            // Update quantity
            item.quantity = newQuantity;

            // Save and re-render
            saveInventory();
            renderInventory();
        }
    </script>
</body>
</html>
