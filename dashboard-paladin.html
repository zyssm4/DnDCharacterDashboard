<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Paladin Dashboard</title>
    <link rel="icon" type="image/svg+xml" href="assets/icons/favicon.svg">
    <link rel="stylesheet" href="assets/css/shared-styles.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f57f17 0%, #ff6f00 50%, #1a1a1a 100%);
            color: #fff9c4;
            min-height: 100vh;
        }

        .navbar {
            background: rgba(255, 213, 79, 0.95);
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .navbar h1 {
            color: #f57f17;
            font-size: 1.5em;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
        }

        .nav-menu {
            display: flex;
            gap: 20px;
        }

        .nav-item {
            padding: 10px 20px;
            background: rgba(245, 127, 23, 0.8);
            border: 2px solid #ffd54f;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
            color: #fff9c4;
            font-weight: bold;
        }

        .nav-item:hover {
            background: rgba(255, 213, 79, 0.9);
            border-color: #fff9c4;
            transform: translateY(-2px);
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: 300px 1fr 350px;
            gap: 20px;
            margin-top: 20px;
        }

        .card {
            background: rgba(245, 127, 23, 0.2);
            padding: 20px;
            border-radius: 10px;
            border: 2px solid #ffd54f;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
        }

        .card h2 {
            color: #fff9c4;
            margin-bottom: 15px;
            font-size: 1.3em;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
        }

        .stat-compact {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: rgba(0,0,0,0.3);
            border-radius: 5px;
            margin-bottom: 8px;
            border: 1px solid #ffd54f;
        }

        .stat-compact.proficient {
            background: rgba(255, 213, 79, 0.3);
            border-color: #fff9c4;
        }

        .stat-name {
            font-weight: bold;
            color: #fff9c4;
        }

        .stat-value {
            font-size: 1.2em;
            font-weight: bold;
            color: #fff9c4;
        }

        .ability-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }

        .ability-box {
            background: rgba(0,0,0,0.4);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            border: 2px solid #ffd54f;
        }

        .ability-box .label {
            font-size: 0.8em;
            color: #fff9c4;
            margin-bottom: 5px;
        }

        .ability-box .value {
            font-size: 1.8em;
            font-weight: bold;
        }

        .ability-box .modifier {
            font-size: 1.1em;
            color: #ffecb3;
        }

        .hp-tracker {
            background: rgba(0,0,0,0.4);
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            margin-bottom: 15px;
            border: 2px solid #ffd54f;
        }

        .hp-display {
            font-size: 3em;
            font-weight: bold;
            color: #ffd54f;
        }

        .hp-max {
            font-size: 1.2em;
            color: #ffecb3;
            margin-top: 5px;
        }

        .hp-controls {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            justify-content: center;
        }

        .btn {
            padding: 10px 20px;
            background: #f57f17;
            color: #fff9c4;
            border: 2px solid #ffd54f;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 1em;
            font-weight: bold;
        }

        .btn:hover {
            background: #ff8f00;
            border-color: #fff9c4;
            box-shadow: 0 4px 8px rgba(255, 213, 79, 0.4);
        }

        .btn-small {
            padding: 5px 15px;
            font-size: 0.9em;
        }

        .btn-danger {
            background: #c62828;
            border-color: #e57373;
        }

        .btn-danger:hover {
            background: #d32f2f;
        }

        /* Lay on Hands */
        .lay-on-hands-box {
            background: linear-gradient(135deg, rgba(255, 213, 79, 0.4), rgba(255, 236, 179, 0.2));
            padding: 20px;
            border-radius: 10px;
            border: 3px solid #fff9c4;
            margin-bottom: 15px;
            text-align: center;
        }

        .lay-on-hands-box h3 {
            color: #fff9c4;
            margin-bottom: 10px;
            font-size: 1.2em;
        }

        .healing-pool {
            font-size: 2.5em;
            font-weight: bold;
            color: #ffd54f;
            text-shadow: 0 0 10px rgba(255, 213, 79, 0.8);
        }

        .healing-controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 15px;
        }

        .healing-input {
            width: 80px;
            padding: 8px;
            background: rgba(0,0,0,0.4);
            border: 2px solid #ffd54f;
            border-radius: 5px;
            color: #fff9c4;
            text-align: center;
            font-size: 1.2em;
        }

        /* Divine Sense & Channel Divinity */
        .divine-resource-box {
            background: rgba(0,0,0,0.4);
            padding: 15px;
            border-radius: 8px;
            border: 2px solid #ffd54f;
            margin-bottom: 15px;
        }

        .divine-resource-box h3 {
            color: #fff9c4;
            margin-bottom: 10px;
            font-size: 1.1em;
        }

        .resource-circles {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 10px;
        }

        .resource-circle {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            border: 3px solid #ffd54f;
            background: rgba(0,0,0,0.5);
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2em;
        }

        .resource-circle.available {
            background: linear-gradient(135deg, #ffd54f, #fff9c4);
            box-shadow: 0 0 15px rgba(255, 213, 79, 0.6);
        }

        .resource-circle:hover {
            transform: scale(1.1);
        }

        /* Spell Slots */
        .spell-slots-compact {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
        }

        .slot-compact {
            flex: 1;
            min-width: 80px;
            background: rgba(0,0,0,0.4);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            border: 2px solid #ffd54f;
        }

        .slot-compact .level {
            font-size: 1em;
            color: #fff9c4;
            margin-bottom: 8px;
            font-weight: bold;
        }

        .slot-compact .circles {
            display: flex;
            gap: 5px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .slot-circle-mini {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            border: 2px solid #ffd54f;
            cursor: pointer;
            transition: all 0.3s;
            background: rgba(0,0,0,0.5);
        }

        .slot-circle-mini.used {
            background: #f57f17;
        }

        .slot-circle-mini:hover {
            transform: scale(1.1);
            border-color: #fff9c4;
        }

        /* Divine Smite Info */
        .smite-info-box {
            background: rgba(255, 213, 79, 0.2);
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #ffd54f;
            margin-bottom: 15px;
        }

        .smite-info-box h4 {
            color: #fff9c4;
            margin-bottom: 8px;
        }

        .smite-info-box p {
            font-size: 0.9em;
            color: #ffecb3;
            line-height: 1.4;
        }

        /* Spells */
        .spell-compact {
            background: rgba(0,0,0,0.3);
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 8px;
            border-left: 3px solid #ffd54f;
            cursor: pointer;
            transition: all 0.3s;
        }

        .spell-compact:hover {
            background: rgba(255, 213, 79, 0.2);
            border-left-width: 5px;
        }

        .spell-compact.prepared {
            background: rgba(255, 213, 79, 0.3);
            border-left-color: #fff9c4;
            border-left-width: 4px;
        }

        .spell-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }

        .spell-name {
            font-weight: bold;
            color: #fff9c4;
        }

        .spell-level {
            font-size: 0.8em;
            color: #ffd54f;
            background: rgba(255, 213, 79, 0.3);
            padding: 2px 8px;
            border-radius: 10px;
        }

        .spell-details {
            font-size: 0.85em;
            color: #ffecb3;
            margin-bottom: 5px;
        }

        .spell-description {
            font-size: 0.8em;
            color: #fff9c4;
            line-height: 1.4;
            display: none;
        }

        .spell-compact.expanded .spell-description {
            display: block;
            margin-top: 8px;
        }

        .prepared-spells-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .prepared-count {
            background: rgba(255, 213, 79, 0.3);
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
            text-align: center;
            border: 2px solid #ffd54f;
        }

        /* Rest buttons */
        .rest-section {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .rest-section .btn {
            flex: 1;
        }

        .feature-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .feature-item {
            background: rgba(0,0,0,0.4);
            padding: 12px;
            border-radius: 5px;
            margin-bottom: 8px;
            border-left: 3px solid #fff9c4;
        }

        .feature-item h4 {
            color: #fff9c4;
            margin-bottom: 5px;
        }

        .feature-item p {
            font-size: 0.9em;
            color: #ffecb3;
            line-height: 1.4;
        }

        @media (max-width: 1200px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Scrollbar styling */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(0,0,0,0.3);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: #ffd54f;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #ff8f00;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(255,255,255,0.3);
            border-top-color: #fff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .notification {
            padding: 15px 20px;
            margin-bottom: 10px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            animation: slideIn 0.3s ease;
            max-width: 300px;
        }

        .notification.success { background: #4CAF50; }
        .notification.error { background: #f44336; }
        .notification.warning { background: #ff9800; }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
    </style>
</head>
<body>
    <div id="notification-container" style="position: fixed; top: 20px; right: 20px; z-index: 1000;"></div>
    <div id="loading-overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 999; justify-content: center; align-items: center;">
        <div class="loading-spinner"></div>
    </div>

    <nav class="navbar">
        <h1>‚öîÔ∏è <span id="characterName">Paladin</span> - Stufe <span id="characterLevel">1</span></h1>
        <div class="nav-menu">
            <a href="class-selection.html" class="nav-item">üé≤ Klassenauswahl</a>
            <a href="#" class="nav-item" onclick="showEquipmentTab()">‚öîÔ∏è Ausr√ºstung</a>
            <a href="#" class="nav-item" onclick="showNotesTab()">üìú Notizen</a>
        </div>
    </nav>

    <div class="container">
        <div class="dashboard-grid">
            <!-- Left Column: Character Stats -->
            <div class="left-column">
                <div class="card">
                    <h2>Attribute</h2>
                    <div class="ability-grid">
                        <div class="ability-box">
                            <div class="label">STR</div>
                            <div class="value" id="strValue">10</div>
                            <div class="modifier" id="strMod">+0</div>
                        </div>
                        <div class="ability-box">
                            <div class="label">DEX</div>
                            <div class="value" id="dexValue">10</div>
                            <div class="modifier" id="dexMod">+0</div>
                        </div>
                        <div class="ability-box">
                            <div class="label">CON</div>
                            <div class="value" id="conValue">10</div>
                            <div class="modifier" id="conMod">+0</div>
                        </div>
                        <div class="ability-box">
                            <div class="label">INT</div>
                            <div class="value" id="intValue">10</div>
                            <div class="modifier" id="intMod">+0</div>
                        </div>
                        <div class="ability-box">
                            <div class="label">WIS</div>
                            <div class="value" id="wisValue">10</div>
                            <div class="modifier" id="wisMod">+0</div>
                        </div>
                        <div class="ability-box">
                            <div class="label">CHA</div>
                            <div class="value" id="chaValue">10</div>
                            <div class="modifier" id="chaMod">+0</div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h2>Kampfwerte</h2>
                    <div class="stat-compact">
                        <span class="stat-name">R√ºstungsklasse</span>
                        <span class="stat-value" id="armorClass">10</span>
                    </div>
                    <div class="stat-compact">
                        <span class="stat-name">Initiative</span>
                        <span class="stat-value" id="initiative">+0</span>
                    </div>
                    <div class="stat-compact">
                        <span class="stat-name">Geschwindigkeit</span>
                        <span class="stat-value" id="speed">9m</span>
                    </div>
                    <div class="stat-compact">
                        <span class="stat-name">√úbungsbonus</span>
                        <span class="stat-value" id="profBonus">+2</span>
                    </div>
                    <div class="stat-compact" id="spellDCRow" style="display: none;">
                        <span class="stat-name">Zauber-SG</span>
                        <span class="stat-value" id="spellDC">13</span>
                    </div>
                </div>

                <div class="card">
                    <h2>Rettungsw√ºrfe</h2>
                    <div class="stat-compact proficient">
                        <span class="stat-name">Weisheit</span>
                        <span class="stat-value" id="saveWis">+0</span>
                    </div>
                    <div class="stat-compact proficient">
                        <span class="stat-name">Charisma</span>
                        <span class="stat-value" id="saveCha">+0</span>
                    </div>
                    <div class="stat-compact">
                        <span class="stat-name">St√§rke</span>
                        <span class="stat-value" id="saveStr">+0</span>
                    </div>
                    <div class="stat-compact">
                        <span class="stat-name">Geschicklichkeit</span>
                        <span class="stat-value" id="saveDex">+0</span>
                    </div>
                    <div class="stat-compact">
                        <span class="stat-name">Konstitution</span>
                        <span class="stat-value" id="saveCon">+0</span>
                    </div>
                    <div class="stat-compact">
                        <span class="stat-name">Intelligenz</span>
                        <span class="stat-value" id="saveInt">+0</span>
                    </div>
                </div>

                <div class="card">
                    <h2>Fertigkeiten</h2>
                    <div id="skillsList">
                        <!-- Skills will be loaded here -->
                    </div>
                </div>
            </div>

            <!-- Middle Column: Combat & Features -->
            <div class="middle-column">
                <div class="card">
                    <h2>Trefferpunkte</h2>
                    <div class="hp-tracker">
                        <div class="hp-display" id="currentHP">10</div>
                        <div class="hp-max">/ <span id="maxHP">10</span> TP</div>
                        <div class="hp-controls">
                            <button class="btn btn-small" onclick="adjustHP(1)">+1</button>
                            <button class="btn btn-small" onclick="adjustHP(5)">+5</button>
                            <button class="btn btn-small btn-danger" onclick="adjustHP(-1)">-1</button>
                            <button class="btn btn-small btn-danger" onclick="adjustHP(-5)">-5</button>
                        </div>
                    </div>

                    <div class="rest-section">
                        <button class="btn" onclick="shortRest()">Kurze Rast</button>
                        <button class="btn" onclick="longRest()">Lange Rast</button>
                    </div>
                </div>

                <!-- Lay on Hands -->
                <div class="card">
                    <div class="lay-on-hands-box">
                        <h3>üôè Handauflegen</h3>
                        <div class="healing-pool">
                            <span id="layOnHandsCurrent">5</span> / <span id="layOnHandsMax">5</span> TP
                        </div>
                        <div class="healing-controls">
                            <input type="number" class="healing-input" id="healAmount" placeholder="TP" min="1">
                            <button class="btn" onclick="useLayOnHands()">Heilen</button>
                        </div>
                        <div style="margin-top: 10px; font-size: 0.9em;">5 TP = Krankheit/Gift heilen</div>
                    </div>
                </div>

                <!-- Divine Sense -->
                <div class="card">
                    <div class="divine-resource-box">
                        <h3>‚ú® G√∂ttliches Gesp√ºr</h3>
                        <div>Himmelswesen, Untote & Feindes innerhalb 18m sp√ºren</div>
                        <div class="resource-circles" id="divineSenseCircles">
                            <!-- Will be generated dynamically -->
                        </div>
                    </div>
                </div>

                <!-- Channel Divinity -->
                <div class="card" id="channelDivinityCard" style="display: none;">
                    <div class="divine-resource-box">
                        <h3>‚ö° Kanalisierende G√∂ttlichkeit</h3>
                        <div id="channelDivinityDesc">Verf√ºgbar ab Stufe 3</div>
                        <div class="resource-circles" id="channelDivinityCircles">
                            <!-- Will be generated dynamically -->
                        </div>
                    </div>
                </div>

                <!-- Divine Smite Info -->
                <div class="card" id="divineSmiteCard" style="display: none;">
                    <div class="smite-info-box">
                        <h4>‚öîÔ∏è G√∂ttlicher Schlag</h4>
                        <p>Bei Nahkampftreffer Zauberplatz ausgeben:</p>
                        <p><strong>Stufe 1:</strong> +2W8 glei√üender Schaden</p>
                        <p><strong>Stufe 2:</strong> +3W8 glei√üender Schaden</p>
                        <p><strong>Stufe 3:</strong> +4W8 glei√üender Schaden</p>
                        <p><strong>Maximum:</strong> 5W8 (+1W8 gegen Untote/Feindes)</p>
                    </div>
                </div>

                <!-- Spell Slots -->
                <div class="card" id="spellSlotsCard" style="display: none;">
                    <h2>Zauberpl√§tze</h2>
                    <div class="spell-slots-compact" id="spellSlots">
                        <!-- Spell slots will be loaded here -->
                    </div>
                </div>

                <!-- Class Features -->
                <div class="card">
                    <h2>Klassenf√§higkeiten</h2>
                    <div class="feature-list" id="featuresList">
                        <!-- Features will be loaded here -->
                    </div>
                </div>
            </div>

            <!-- Right Column: Spells & Equipment -->
            <div class="right-column">
                <div class="card" id="spellsCard" style="display: none;">
                    <h2>Vorbereitete Zauber</h2>
                    <div class="prepared-count">
                        <span id="preparedCount">0</span> / <span id="maxPrepared">0</span> vorbereitet
                    </div>
                    <div class="prepared-spells-list" id="spellsList">
                        <!-- Spells will be loaded here -->
                    </div>
                </div>

                <div class="card">
                    <h2>Ausr√ºstung</h2>
                    <div id="equipmentList">
                        <!-- Equipment will be loaded here -->
                    </div>
                    <button class="btn" style="width: 100%; margin-top: 10px;" onclick="showEquipmentBrowser()">
                        üì¶ Ausr√ºstung durchsuchen
                    </button>
                </div>

                <div class="card">
                    <h2>Heiliger Eid: <span id="oathName">-</span></h2>
                    <div id="oathFeature">
                        <p style="color: #ffecb3;">Wird ab Stufe 3 gew√§hlt</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_URL = 'db_actions.php';
        let characterStats = {};
        let characterId = 1;
        let layOnHandsPool = 0;

        function showNotification(message, type = 'success') {
            const container = document.getElementById('notification-container');
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            container.appendChild(notification);
            setTimeout(() => notification.remove(), 3000);
        }

        function showLoading() {
            document.getElementById('loading-overlay').style.display = 'flex';
        }

        function hideLoading() {
            document.getElementById('loading-overlay').style.display = 'none';
        }

        const skills = {
            'athletics': { name: 'Athletik', ability: 'str' },
            'insight': { name: 'Motiv erkennen', ability: 'wis' },
            'intimidation': { name: 'Einsch√ºchtern', ability: 'cha' },
            'medicine': { name: 'Heilkunde', ability: 'wis' },
            'persuasion': { name: '√úberzeugen', ability: 'cha' },
            'religion': { name: 'Religion', ability: 'int' },
            'acrobatics': { name: 'Akrobatik', ability: 'dex' },
            'animal_handling': { name: 'Tierf√ºhrung', ability: 'wis' },
            'arcana': { name: 'Arkane Kunde', ability: 'int' },
            'deception': { name: 'T√§uschung', ability: 'cha' },
            'history': { name: 'Geschichte', ability: 'int' },
            'investigation': { name: 'Nachforschung', ability: 'int' },
            'nature': { name: 'Naturkunde', ability: 'int' },
            'perception': { name: 'Wahrnehmung', ability: 'wis' },
            'performance': { name: 'Auftreten', ability: 'cha' },
            'sleight_of_hand': { name: 'Fingerfertigkeit', ability: 'dex' },
            'stealth': { name: 'Heimlichkeit', ability: 'dex' },
            'survival': { name: '√úberlebenskunst', ability: 'wis' }
        };

        const spellSlotsByLevel = {
            2: [0, 2, 0, 0, 0, 0],
            3: [0, 3, 0, 0, 0, 0],
            4: [0, 3, 0, 0, 0, 0],
            5: [0, 4, 2, 0, 0, 0],
            6: [0, 4, 2, 0, 0, 0],
            7: [0, 4, 3, 0, 0, 0],
            8: [0, 4, 3, 0, 0, 0],
            9: [0, 4, 3, 2, 0, 0],
            10: [0, 4, 3, 2, 0, 0],
        };

        async function loadCharacter() {
            try {
                showLoading();
                const response = await fetch(`${API_URL}?action=character&class=paladin`);
                const result = await response.json();

                if (result.success && result.data) {
                    const char = result.data;
                    characterStats = char;
                    characterId = char.id;

                    document.getElementById('characterName').textContent = char.name;
                    document.getElementById('characterLevel').textContent = char.level;

                    updateAbilities(char);

                    const profBonus = getProficiencyBonus(char.level);
                    document.getElementById('armorClass').textContent = char.armor_class || 10;
                    document.getElementById('speed').textContent = '9m';
                    document.getElementById('profBonus').textContent = '+' + profBonus;

                    document.getElementById('currentHP').textContent = char.current_hp;
                    document.getElementById('maxHP').textContent = char.max_hp;

                    // Lay on Hands
                    layOnHandsPool = char.level * 5;
                    document.getElementById('layOnHandsMax').textContent = layOnHandsPool;
                    document.getElementById('layOnHandsCurrent').textContent = layOnHandsPool; // TODO: load from DB

                    // Divine Sense (1 + CHA mod)
                    const chaMod = Math.floor((char.charisma - 10) / 2);
                    const divineSenseUses = Math.max(1, 1 + chaMod);
                    generateResourceCircles('divineSenseCircles', divineSenseUses, '‚ú®');

                    // Show spell-related UI if level 2+
                    if (char.level >= 2) {
                        document.getElementById('spellDCRow').style.display = 'flex';
                        document.getElementById('spellSlotsCard').style.display = 'block';
                        document.getElementById('spellsCard').style.display = 'block';
                        document.getElementById('divineSmiteCard').style.display = 'block';

                        const spellDC = 8 + profBonus + chaMod;
                        document.getElementById('spellDC').textContent = spellDC;

                        const maxPrepared = Math.max(1, chaMod + Math.floor(char.level / 2));
                        document.getElementById('maxPrepared').textContent = maxPrepared;

                        loadSpellSlots(char);
                        loadSpells(char);
                    }

                    // Show Channel Divinity if level 3+
                    if (char.level >= 3) {
                        document.getElementById('channelDivinityCard').style.display = 'block';
                        const channelUses = char.level >= 18 ? 3 : (char.level >= 6 ? 2 : 1);
                        generateResourceCircles('channelDivinityCircles', channelUses, '‚ö°');

                        // Show oath
                        if (char.subclass) {
                            const oathNames = {
                                'devotion': 'Hingabe',
                                'vengeance': 'Rache',
                                'ancients': 'Alten'
                            };
                            document.getElementById('oathName').textContent = oathNames[char.subclass] || char.subclass;
                        }
                    }

                    loadSkills(char);
                    loadFeatures(char);
                    loadEquipment(char);
                } else {
                    throw new Error('Kein Charakter gefunden');
                }
            } catch (error) {
                console.error('Fehler beim Laden des Charakters:', error);
                showNotification(error.message || 'Fehler beim Laden des Charakters', 'error');
            } finally {
                hideLoading();
            }
        }

        function generateResourceCircles(containerId, count, icon) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';

            for (let i = 0; i < count; i++) {
                const circle = document.createElement('div');
                circle.className = 'resource-circle available';
                circle.textContent = icon;
                circle.onclick = () => circle.classList.toggle('available');
                container.appendChild(circle);
            }
        }

        function updateAbilities(char) {
            const abilities = {
                str: char.strength,
                dex: char.dexterity,
                con: char.constitution,
                int: char.intelligence,
                wis: char.wisdom,
                cha: char.charisma
            };

            Object.entries(abilities).forEach(([key, value]) => {
                document.getElementById(`${key}Value`).textContent = value;
                const modifier = Math.floor((value - 10) / 2);
                const modText = modifier >= 0 ? `+${modifier}` : `${modifier}`;
                document.getElementById(`${key}Mod`).textContent = modText;
            });

            const profBonus = getProficiencyBonus(char.level);
            const saveProficiencies = ['wis', 'cha'];

            Object.entries(abilities).forEach(([key, value]) => {
                const modifier = Math.floor((value - 10) / 2);
                const isProficient = saveProficiencies.includes(key);
                const saveBonus = modifier + (isProficient ? profBonus : 0);
                const saveText = saveBonus >= 0 ? `+${saveBonus}` : `${saveBonus}`;
                const saveId = `save${key.charAt(0).toUpperCase() + key.slice(1)}`;
                if (document.getElementById(saveId)) {
                    document.getElementById(saveId).textContent = saveText;
                }
            });

            const dexMod = Math.floor((char.dexterity - 10) / 2);
            document.getElementById('initiative').textContent = dexMod >= 0 ? `+${dexMod}` : `${dexMod}`;
        }

        function loadSkills(char) {
            const skillsList = document.getElementById('skillsList');
            skillsList.innerHTML = '';

            const profBonus = getProficiencyBonus(char.level);
            const proficientSkills = JSON.parse(char.proficient_skills || '[]');

            Object.entries(skills).forEach(([key, skill]) => {
                const abilityMod = Math.floor((characterStats[skill.ability] - 10) / 2);
                const isProficient = proficientSkills.includes(key);

                const bonus = abilityMod + (isProficient ? profBonus : 0);
                const bonusText = bonus >= 0 ? `+${bonus}` : `${bonus}`;

                const div = document.createElement('div');
                div.className = 'stat-compact' + (isProficient ? ' proficient' : '');
                div.innerHTML = `
                    <span class="stat-name">${skill.name}</span>
                    <span class="stat-value">${bonusText}</span>
                `;
                skillsList.appendChild(div);
            });
        }

        async function loadFeatures(char) {
            try {
                const response = await fetch(`${API_URL}?action=class_features&class=paladin&level=${char.level}`);
                const result = await response.json();

                const featuresList = document.getElementById('featuresList');
                featuresList.innerHTML = '';

                if (result.success && result.data) {
                    result.data.forEach(feature => {
                        const div = document.createElement('div');
                        div.className = 'feature-item';
                        div.innerHTML = `
                            <h4>${feature.feature_name_de}</h4>
                            <p>${feature.description_de}</p>
                        `;
                        featuresList.appendChild(div);
                    });
                }
            } catch (error) {
                console.error('Fehler beim Laden der Features:', error);
            }
        }

        function loadSpellSlots(char) {
            const slotsContainer = document.getElementById('spellSlots');
            slotsContainer.innerHTML = '';

            const slots = spellSlotsByLevel[char.level];
            if (!slots) return;

            const usedSlots = JSON.parse(char.used_spell_slots || '{}');

            for (let level = 1; level <= 5; level++) {
                const maxSlots = slots[level] || 0;
                if (maxSlots === 0) continue;

                const slotDiv = document.createElement('div');
                slotDiv.className = 'slot-compact';

                const circlesHTML = [];
                for (let i = 0; i < maxSlots; i++) {
                    const isUsed = (usedSlots[level] || []).includes(i);
                    circlesHTML.push(`<div class="slot-circle-mini ${isUsed ? 'used' : ''}" onclick="toggleSpellSlot(${level}, ${i})"></div>`);
                }

                slotDiv.innerHTML = `
                    <div class="level">Stufe ${level}</div>
                    <div class="circles">${circlesHTML.join('')}</div>
                `;
                slotsContainer.appendChild(slotDiv);
            }
        }

        async function loadSpells(char) {
            if (char.level < 2) return;

            try {
                const response = await fetch(`${API_URL}?action=spells&class=paladin`);
                const result = await response.json();

                if (result.success) {
                    const preparedSpells = JSON.parse(char.prepared_spells || '[]');
                    const spellsList = document.getElementById('spellsList');
                    spellsList.innerHTML = '';

                    const filteredSpells = result.data.filter(spell => preparedSpells.includes(spell.id));
                    document.getElementById('preparedCount').textContent = filteredSpells.length;

                    filteredSpells.forEach(spell => {
                        const div = document.createElement('div');
                        div.className = 'spell-compact prepared';

                        div.innerHTML = `
                            <div class="spell-header">
                                <span class="spell-name">${spell.name_de}</span>
                                <span class="spell-level">Stufe ${spell.level}</span>
                            </div>
                            <div class="spell-details">
                                ${spell.school_de} ‚Ä¢ ${spell.casting_time_de} ‚Ä¢ ${spell.range_de}
                            </div>
                            <div class="spell-description">${spell.description_de}</div>
                        `;

                        div.onclick = () => div.classList.toggle('expanded');
                        spellsList.appendChild(div);
                    });
                }
            } catch (error) {
                console.error('Fehler beim Laden der Zauber:', error);
            }
        }

        function loadEquipment(char) {
            const equipmentList = document.getElementById('equipmentList');
            equipmentList.innerHTML = '';

            const inventory = JSON.parse(char.inventory || '[]');

            if (inventory.length === 0) {
                equipmentList.innerHTML = '<p style="color: #fff9c4; text-align: center;">Keine Ausr√ºstung</p>';
                return;
            }

            inventory.forEach(item => {
                const div = document.createElement('div');
                div.className = 'stat-compact';
                div.innerHTML = `
                    <span class="stat-name">${item.name}</span>
                    <span>${item.quantity || 1}√ó</span>
                `;
                equipmentList.appendChild(div);
            });
        }

        function useLayOnHands() {
            const amount = parseInt(document.getElementById('healAmount').value);
            const current = parseInt(document.getElementById('layOnHandsCurrent').textContent);

            if (!amount || amount < 1) {
                alert('Gib eine g√ºltige Menge TP ein!');
                return;
            }

            if (amount > current) {
                alert('Nicht genug Trefferpunkte im Vorrat!');
                return;
            }

            const newPool = current - amount;
            document.getElementById('layOnHandsCurrent').textContent = newPool;
            document.getElementById('healAmount').value = '';

            alert(`${amount} TP geheilt!${amount >= 5 ? ' (Oder Krankheit/Gift geheilt)' : ''}`);
            // TODO: Save to DB
        }

        function toggleSpellSlot(level, index) {
            const circle = event.target;
            circle.classList.toggle('used');
            // TODO: Save to DB
        }

        function getProficiencyBonus(level) {
            return Math.ceil(level / 4) + 1;
        }

        function adjustHP(amount) {
            const current = parseInt(document.getElementById('currentHP').textContent);
            const max = parseInt(document.getElementById('maxHP').textContent);
            const newHP = Math.max(0, Math.min(max, current + amount));
            document.getElementById('currentHP').textContent = newHP;
            updateCharacterHP(newHP);
        }

        async function updateCharacterHP(newHP) {
            try {
                const formData = new FormData();
                formData.append('character_id', characterId);
                formData.append('current_hp', newHP);
                const response = await fetch(`${API_URL}?action=update_hp`, { method: 'POST', body: formData });
                const data = await response.json();
                if (!data.success) throw new Error(data.error || 'HP-Update fehlgeschlagen');
                showNotification('HP gespeichert!');
            } catch (error) {
                console.error('Fehler beim Speichern der HP:', error);
                showNotification(error.message || 'Fehler beim Speichern der HP', 'error');
            }
        }

        async function shortRest() {
            if (confirm('Kurze Rast nehmen? (1 Stunde) Du kannst Trefferw√ºrfel verwenden.')) {
                showNotification('Kurze Rast abgeschlossen! Kanalisierende G√∂ttlichkeit wiederhergestellt.');
                // Restore Channel Divinity
                loadCharacter();
            }
        }

        async function longRest() {
            if (confirm('Lange Rast nehmen? (8 Stunden) HP, Zauberpl√§tze und alle Ressourcen werden wiederhergestellt.')) {
                // Restore Lay on Hands
                document.getElementById('layOnHandsCurrent').textContent = layOnHandsPool;

                try {
                    showLoading();
                    const response = await fetch(`${API_URL}?action=long_rest&character_id=${characterId}`);
                    const result = await response.json();
                    if (result.success) {
                        showNotification('Lange Rast abgeschlossen!');
                        loadCharacter();
                    } else {
                        throw new Error(result.error || 'Lange Rast fehlgeschlagen');
                    }
                } catch (error) {
                    console.error('Fehler bei langer Rast:', error);
                    showNotification(error.message || 'Fehler bei langer Rast', 'error');
                } finally {
                    hideLoading();
                }
            }
        }

        function showEquipmentTab() {
            alert('Ausr√ºstungsverwaltung wird geladen...');
        }

        function showNotesTab() {
            alert('Notizfunktion wird geladen...');
        }

        function showEquipmentBrowser() {
            alert('Ausr√ºstungs-Browser wird geladen...');
        }

        window.addEventListener('load', () => {
            loadCharacter();
        });
    </script>
</body>
</html>
