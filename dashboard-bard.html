<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Barden Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #4a148c 0%, #1a0033 100%);
            color: #f3e5f5;
            min-height: 100vh;
        }

        .navbar {
            background: rgba(171, 71, 188, 0.9);
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .navbar h1 {
            color: #ce93d8;
            font-size: 1.5em;
        }

        .nav-menu {
            display: flex;
            gap: 20px;
        }

        .nav-item {
            padding: 10px 20px;
            background: rgba(0,0,0,0.3);
            border: 2px solid #ab47bc;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
            color: #f3e5f5;
        }

        .nav-item:hover {
            background: rgba(171, 71, 188, 0.5);
            border-color: #ce93d8;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: 300px 1fr 350px;
            gap: 20px;
            margin-top: 20px;
        }

        .card {
            background: rgba(74, 20, 140, 0.3);
            padding: 20px;
            border-radius: 10px;
            border: 2px solid #ab47bc;
        }

        .card h2 {
            color: #ce93d8;
            margin-bottom: 15px;
            font-size: 1.3em;
        }

        .stat-compact {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: rgba(0,0,0,0.3);
            border-radius: 5px;
            margin-bottom: 8px;
            border: 1px solid #ab47bc;
        }

        .stat-compact.proficient {
            background: rgba(171, 71, 188, 0.4);
            border-color: #ce93d8;
        }

        .stat-name {
            font-weight: bold;
            color: #ce93d8;
        }

        .stat-value {
            font-size: 1.2em;
            font-weight: bold;
            color: #f3e5f5;
        }

        .ability-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }

        .ability-box {
            background: rgba(0,0,0,0.4);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            border: 2px solid #ab47bc;
        }

        .ability-box .label {
            font-size: 0.8em;
            color: #ce93d8;
            margin-bottom: 5px;
        }

        .ability-box .value {
            font-size: 1.8em;
            font-weight: bold;
        }

        .ability-box .modifier {
            font-size: 1.1em;
            color: #e1bee7;
        }

        .hp-tracker {
            background: rgba(0,0,0,0.4);
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            margin-bottom: 15px;
            border: 2px solid #ab47bc;
        }

        .hp-display {
            font-size: 3em;
            font-weight: bold;
            color: #ab47bc;
        }

        .hp-max {
            font-size: 1.2em;
            color: #e1bee7;
            margin-top: 5px;
        }

        .hp-controls {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            justify-content: center;
        }

        .btn {
            padding: 10px 20px;
            background: #7b1fa2;
            color: #f3e5f5;
            border: 2px solid #ab47bc;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 1em;
        }

        .btn:hover {
            background: #8e24aa;
            border-color: #ce93d8;
        }

        .btn-small {
            padding: 5px 15px;
            font-size: 0.9em;
        }

        .btn-danger {
            background: #c62828;
            border-color: #e57373;
        }

        .btn-danger:hover {
            background: #d32f2f;
        }

        /* Bardic Inspiration */
        .inspiration-box {
            background: linear-gradient(135deg, rgba(171, 71, 188, 0.4), rgba(206, 147, 216, 0.2));
            padding: 20px;
            border-radius: 10px;
            border: 3px solid #ce93d8;
            margin-bottom: 15px;
            text-align: center;
        }

        .inspiration-box h3 {
            color: #e1bee7;
            margin-bottom: 10px;
            font-size: 1.2em;
        }

        .inspiration-die {
            font-size: 2.5em;
            font-weight: bold;
            color: #ab47bc;
            margin-bottom: 10px;
        }

        .inspiration-circles {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 15px;
        }

        .inspiration-circle {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 3px solid #ab47bc;
            background: rgba(0,0,0,0.5);
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2em;
        }

        .inspiration-circle.available {
            background: linear-gradient(135deg, #ab47bc, #ce93d8);
            box-shadow: 0 0 15px rgba(171, 71, 188, 0.6);
        }

        .inspiration-circle:hover {
            transform: scale(1.1);
        }

        /* Spell Slots */
        .spell-slots-compact {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
        }

        .slot-compact {
            flex: 1;
            min-width: 80px;
            background: rgba(0,0,0,0.4);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            border: 2px solid #ab47bc;
        }

        .slot-compact .level {
            font-size: 1em;
            color: #ce93d8;
            margin-bottom: 8px;
            font-weight: bold;
        }

        .slot-compact .circles {
            display: flex;
            gap: 5px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .slot-circle-mini {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            border: 2px solid #ab47bc;
            cursor: pointer;
            transition: all 0.3s;
            background: rgba(0,0,0,0.5);
        }

        .slot-circle-mini.used {
            background: #7b1fa2;
        }

        .slot-circle-mini:hover {
            transform: scale(1.1);
            border-color: #ce93d8;
        }

        /* Spells */
        .spell-compact {
            background: rgba(0,0,0,0.3);
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 8px;
            border-left: 3px solid #ab47bc;
            cursor: pointer;
            transition: all 0.3s;
        }

        .spell-compact:hover {
            background: rgba(171, 71, 188, 0.2);
            border-left-width: 5px;
        }

        .spell-compact.ritual {
            border-left-color: #ffd700;
        }

        .spell-compact.concentration {
            border-right: 3px solid #ff9800;
        }

        .spell-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }

        .spell-name {
            font-weight: bold;
            color: #e1bee7;
        }

        .spell-level {
            font-size: 0.8em;
            color: #ab47bc;
            background: rgba(171, 71, 188, 0.3);
            padding: 2px 8px;
            border-radius: 10px;
        }

        .spell-details {
            font-size: 0.85em;
            color: #ce93d8;
            margin-bottom: 5px;
        }

        .spell-description {
            font-size: 0.8em;
            color: #f3e5f5;
            line-height: 1.4;
            display: none;
        }

        .spell-compact.expanded .spell-description {
            display: block;
            margin-top: 8px;
        }

        .prepared-spells-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .spell-filter {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 5px 15px;
            background: rgba(0,0,0,0.3);
            border: 2px solid #ab47bc;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.9em;
            color: #ce93d8;
        }

        .filter-btn.active {
            background: rgba(171, 71, 188, 0.5);
            border-color: #ce93d8;
        }

        .filter-btn:hover {
            background: rgba(171, 71, 188, 0.3);
        }

        /* Jack of All Trades badge */
        .jack-badge {
            display: inline-block;
            background: #ce93d8;
            color: #4a148c;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.7em;
            font-weight: bold;
            margin-left: 5px;
        }

        /* Rest buttons */
        .rest-section {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .rest-section .btn {
            flex: 1;
        }

        .feature-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .feature-item {
            background: rgba(0,0,0,0.4);
            padding: 12px;
            border-radius: 5px;
            margin-bottom: 8px;
            border-left: 3px solid #ce93d8;
        }

        .feature-item h4 {
            color: #e1bee7;
            margin-bottom: 5px;
        }

        .feature-item p {
            font-size: 0.9em;
            color: #f3e5f5;
            line-height: 1.4;
        }

        @media (max-width: 1200px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Scrollbar styling */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(0,0,0,0.3);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: #ab47bc;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #8e24aa;
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <h1>üéµ <span id="characterName">Barde</span> - Stufe <span id="characterLevel">1</span></h1>
        <div class="nav-menu">
            <a href="class-selection.html" class="nav-item">üé≤ Klassenauswahl</a>
            <a href="#" class="nav-item" onclick="showEquipmentTab()">‚öîÔ∏è Ausr√ºstung</a>
            <a href="#" class="nav-item" onclick="showNotesTab()">üìú Notizen</a>
        </div>
    </nav>

    <div class="container">
        <div class="dashboard-grid">
            <!-- Left Column: Character Stats -->
            <div class="left-column">
                <div class="card">
                    <h2>Attribute</h2>
                    <div class="ability-grid">
                        <div class="ability-box">
                            <div class="label">STR</div>
                            <div class="value" id="strValue">10</div>
                            <div class="modifier" id="strMod">+0</div>
                        </div>
                        <div class="ability-box">
                            <div class="label">DEX</div>
                            <div class="value" id="dexValue">10</div>
                            <div class="modifier" id="dexMod">+0</div>
                        </div>
                        <div class="ability-box">
                            <div class="label">CON</div>
                            <div class="value" id="conValue">10</div>
                            <div class="modifier" id="conMod">+0</div>
                        </div>
                        <div class="ability-box">
                            <div class="label">INT</div>
                            <div class="value" id="intValue">10</div>
                            <div class="modifier" id="intMod">+0</div>
                        </div>
                        <div class="ability-box">
                            <div class="label">WIS</div>
                            <div class="value" id="wisValue">10</div>
                            <div class="modifier" id="wisMod">+0</div>
                        </div>
                        <div class="ability-box">
                            <div class="label">CHA</div>
                            <div class="value" id="chaValue">10</div>
                            <div class="modifier" id="chaMod">+0</div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h2>Kampfwerte</h2>
                    <div class="stat-compact">
                        <span class="stat-name">R√ºstungsklasse</span>
                        <span class="stat-value" id="armorClass">10</span>
                    </div>
                    <div class="stat-compact">
                        <span class="stat-name">Initiative</span>
                        <span class="stat-value" id="initiative">+0</span>
                    </div>
                    <div class="stat-compact">
                        <span class="stat-name">Geschwindigkeit</span>
                        <span class="stat-value" id="speed">9m</span>
                    </div>
                    <div class="stat-compact">
                        <span class="stat-name">√úbungsbonus</span>
                        <span class="stat-value" id="profBonus">+2</span>
                    </div>
                </div>

                <div class="card">
                    <h2>Rettungsw√ºrfe</h2>
                    <div class="stat-compact proficient">
                        <span class="stat-name">Geschicklichkeit</span>
                        <span class="stat-value" id="saveDex">+0</span>
                    </div>
                    <div class="stat-compact proficient">
                        <span class="stat-name">Charisma</span>
                        <span class="stat-value" id="saveCha">+0</span>
                    </div>
                    <div class="stat-compact">
                        <span class="stat-name">St√§rke</span>
                        <span class="stat-value" id="saveStr">+0</span>
                    </div>
                    <div class="stat-compact">
                        <span class="stat-name">Konstitution</span>
                        <span class="stat-value" id="saveCon">+0</span>
                    </div>
                    <div class="stat-compact">
                        <span class="stat-name">Intelligenz</span>
                        <span class="stat-value" id="saveInt">+0</span>
                    </div>
                    <div class="stat-compact">
                        <span class="stat-name">Weisheit</span>
                        <span class="stat-value" id="saveWis">+0</span>
                    </div>
                </div>

                <div class="card">
                    <h2>Fertigkeiten</h2>
                    <div id="skillsList">
                        <!-- Skills will be loaded here -->
                    </div>
                </div>
            </div>

            <!-- Middle Column: Combat & Features -->
            <div class="middle-column">
                <div class="card">
                    <h2>Trefferpunkte</h2>
                    <div class="hp-tracker">
                        <div class="hp-display" id="currentHP">8</div>
                        <div class="hp-max">/ <span id="maxHP">8</span> TP</div>
                        <div class="hp-controls">
                            <button class="btn btn-small" onclick="adjustHP(1)">+1</button>
                            <button class="btn btn-small" onclick="adjustHP(5)">+5</button>
                            <button class="btn btn-small btn-danger" onclick="adjustHP(-1)">-1</button>
                            <button class="btn btn-small btn-danger" onclick="adjustHP(-5)">-5</button>
                        </div>
                    </div>

                    <div class="rest-section">
                        <button class="btn" onclick="shortRest()">Kurze Rast</button>
                        <button class="btn" onclick="longRest()">Lange Rast</button>
                    </div>
                </div>

                <!-- Bardic Inspiration -->
                <div class="card">
                    <div class="inspiration-box">
                        <h3>üéµ Inspiration des Barden</h3>
                        <div class="inspiration-die" id="inspirationDie">d6</div>
                        <div>Bonusaktion ‚Ä¢ Reaktion bei Verb√ºndetem</div>
                        <div class="inspiration-circles" id="inspirationCircles">
                            <!-- Circles will be generated here -->
                        </div>
                    </div>
                </div>

                <!-- Spell Slots -->
                <div class="card">
                    <h2>Zauberpl√§tze</h2>
                    <div class="spell-slots-compact" id="spellSlots">
                        <!-- Spell slots will be loaded here -->
                    </div>
                </div>

                <!-- Class Features -->
                <div class="card">
                    <h2>Klassenf√§higkeiten</h2>
                    <div class="feature-list" id="featuresList">
                        <!-- Features will be loaded here -->
                    </div>
                </div>
            </div>

            <!-- Right Column: Spells -->
            <div class="right-column">
                <div class="card">
                    <h2>Bekannte Zauber</h2>
                    <div class="spell-filter">
                        <div class="filter-btn active" data-level="all" onclick="filterSpells('all')">Alle</div>
                        <div class="filter-btn" data-level="0" onclick="filterSpells(0)">Zaubertricks</div>
                        <div class="filter-btn" data-level="1" onclick="filterSpells(1)">Stufe 1</div>
                        <div class="filter-btn" data-level="2" onclick="filterSpells(2)">Stufe 2</div>
                        <div class="filter-btn" data-level="3" onclick="filterSpells(3)">Stufe 3</div>
                    </div>
                    <div class="prepared-spells-list" id="spellsList">
                        <!-- Spells will be loaded here -->
                    </div>
                </div>

                <div class="card">
                    <h2>Ausr√ºstung</h2>
                    <div id="equipmentList">
                        <!-- Equipment will be loaded here -->
                    </div>
                    <button class="btn" style="width: 100%; margin-top: 10px;" onclick="showEquipmentBrowser()">
                        üì¶ Ausr√ºstung durchsuchen
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_URL = 'db_actions.php';
        let characterStats = {};
        let characterId = 1;
        let currentSpellFilter = 'all';

        // Skills with ability mapping
        const skills = {
            'acrobatics': { name: 'Akrobatik', ability: 'dex' },
            'animal_handling': { name: 'Tierf√ºhrung', ability: 'wis' },
            'arcana': { name: 'Arkane Kunde', ability: 'int' },
            'athletics': { name: 'Athletik', ability: 'str' },
            'deception': { name: 'T√§uschung', ability: 'cha' },
            'history': { name: 'Geschichte', ability: 'int' },
            'insight': { name: 'Motiv erkennen', ability: 'wis' },
            'intimidation': { name: 'Einsch√ºchtern', ability: 'cha' },
            'investigation': { name: 'Nachforschung', ability: 'int' },
            'medicine': { name: 'Heilkunde', ability: 'wis' },
            'nature': { name: 'Naturkunde', ability: 'int' },
            'perception': { name: 'Wahrnehmung', ability: 'wis' },
            'performance': { name: 'Auftreten', ability: 'cha' },
            'persuasion': { name: '√úberzeugen', ability: 'cha' },
            'religion': { name: 'Religion', ability: 'int' },
            'sleight_of_hand': { name: 'Fingerfertigkeit', ability: 'dex' },
            'stealth': { name: 'Heimlichkeit', ability: 'dex' },
            'survival': { name: '√úberlebenskunst', ability: 'wis' }
        };

        // Bardic Inspiration die by level
        const inspirationDice = {
            1: 'd6', 2: 'd6', 3: 'd6', 4: 'd6', 5: 'd8', 6: 'd8', 7: 'd8', 8: 'd8',
            9: 'd8', 10: 'd10', 11: 'd10', 12: 'd10', 13: 'd10', 14: 'd10',
            15: 'd12', 16: 'd12', 17: 'd12', 18: 'd12', 19: 'd12', 20: 'd12'
        };

        // Spell slots by level
        const spellSlotsByLevel = {
            1: [0, 2, 0, 0, 0, 0, 0, 0, 0, 0],
            2: [0, 3, 0, 0, 0, 0, 0, 0, 0, 0],
            3: [0, 4, 2, 0, 0, 0, 0, 0, 0, 0],
            4: [0, 4, 3, 0, 0, 0, 0, 0, 0, 0],
            5: [0, 4, 3, 2, 0, 0, 0, 0, 0, 0],
            // ... continues
        };

        async function loadCharacter() {
            try {
                const response = await fetch(`${API_URL}?action=character&class=bard`);
                const result = await response.json();

                if (result.success && result.data) {
                    const char = result.data;
                    characterStats = char;
                    characterId = char.id;

                    document.getElementById('characterName').textContent = char.name;
                    document.getElementById('characterLevel').textContent = char.level;

                    updateAbilities(char);
                    document.getElementById('armorClass').textContent = char.armor_class || 10;
                    document.getElementById('speed').textContent = '9m';
                    document.getElementById('profBonus').textContent = '+' + getProficiencyBonus(char.level);

                    document.getElementById('currentHP').textContent = char.current_hp;
                    document.getElementById('maxHP').textContent = char.max_hp;

                    // Bardic Inspiration
                    document.getElementById('inspirationDie').textContent = inspirationDice[char.level];
                    generateInspirationCircles(char);

                    loadSkills(char);
                    loadFeatures(char);
                    loadSpellSlots(char);
                    loadSpells(char);
                    loadEquipment(char);
                }
            } catch (error) {
                console.error('Fehler beim Laden des Charakters:', error);
            }
        }

        function generateInspirationCircles(char) {
            const chaMod = Math.floor((char.charisma - 10) / 2);
            const inspirationUses = Math.max(1, chaMod);
            const circles = document.getElementById('inspirationCircles');
            circles.innerHTML = '';

            for (let i = 0; i < inspirationUses; i++) {
                const circle = document.createElement('div');
                circle.className = 'inspiration-circle available';
                circle.textContent = 'üéµ';
                circle.onclick = () => toggleInspiration(circle);
                circles.appendChild(circle);
            }
        }

        function toggleInspiration(circle) {
            circle.classList.toggle('available');
        }

        function updateAbilities(char) {
            const abilities = {
                str: char.strength,
                dex: char.dexterity,
                con: char.constitution,
                int: char.intelligence,
                wis: char.wisdom,
                cha: char.charisma
            };

            Object.entries(abilities).forEach(([key, value]) => {
                document.getElementById(`${key}Value`).textContent = value;
                const modifier = Math.floor((value - 10) / 2);
                const modText = modifier >= 0 ? `+${modifier}` : `${modifier}`;
                document.getElementById(`${key}Mod`).textContent = modText;
            });

            const profBonus = getProficiencyBonus(char.level);
            const saveProficiencies = ['dex', 'cha'];

            Object.entries(abilities).forEach(([key, value]) => {
                const modifier = Math.floor((value - 10) / 2);
                const isProficient = saveProficiencies.includes(key);
                const saveBonus = modifier + (isProficient ? profBonus : 0);
                const saveText = saveBonus >= 0 ? `+${saveBonus}` : `${saveBonus}`;
                const saveId = `save${key.charAt(0).toUpperCase() + key.slice(1)}`;
                if (document.getElementById(saveId)) {
                    document.getElementById(saveId).textContent = saveText;
                }
            });

            const dexMod = Math.floor((char.dexterity - 10) / 2);
            document.getElementById('initiative').textContent = dexMod >= 0 ? `+${dexMod}` : `${dexMod}`;
        }

        function loadSkills(char) {
            const skillsList = document.getElementById('skillsList');
            skillsList.innerHTML = '';

            const profBonus = getProficiencyBonus(char.level);
            const proficientSkills = JSON.parse(char.proficient_skills || '[]');
            const hasJackOfAllTrades = char.level >= 2;

            Object.entries(skills).forEach(([key, skill]) => {
                const abilityMod = Math.floor((characterStats[skill.ability] - 10) / 2);
                const isProficient = proficientSkills.includes(key);

                let bonus = abilityMod;
                if (isProficient) {
                    bonus += profBonus;
                } else if (hasJackOfAllTrades) {
                    bonus += Math.floor(profBonus / 2);
                }

                const bonusText = bonus >= 0 ? `+${bonus}` : `${bonus}`;

                const div = document.createElement('div');
                div.className = 'stat-compact' + (isProficient ? ' proficient' : '');
                div.innerHTML = `
                    <span class="stat-name">
                        ${skill.name}
                        ${!isProficient && hasJackOfAllTrades ? '<span class="jack-badge">¬Ω</span>' : ''}
                    </span>
                    <span class="stat-value">${bonusText}</span>
                `;
                skillsList.appendChild(div);
            });
        }

        async function loadFeatures(char) {
            try {
                const response = await fetch(`${API_URL}?action=class_features&class=bard&level=${char.level}`);
                const result = await response.json();

                const featuresList = document.getElementById('featuresList');
                featuresList.innerHTML = '';

                if (result.success && result.data) {
                    result.data.forEach(feature => {
                        const div = document.createElement('div');
                        div.className = 'feature-item';
                        div.innerHTML = `
                            <h4>${feature.feature_name_de}</h4>
                            <p>${feature.description_de}</p>
                        `;
                        featuresList.appendChild(div);
                    });
                }
            } catch (error) {
                console.error('Fehler beim Laden der Features:', error);
            }
        }

        function loadSpellSlots(char) {
            const slotsContainer = document.getElementById('spellSlots');
            slotsContainer.innerHTML = '';

            const slots = spellSlotsByLevel[char.level] || spellSlotsByLevel[1];
            const usedSlots = JSON.parse(char.used_spell_slots || '{}');

            for (let level = 1; level <= 9; level++) {
                const maxSlots = slots[level] || 0;
                if (maxSlots === 0) continue;

                const slotDiv = document.createElement('div');
                slotDiv.className = 'slot-compact';

                const circlesHTML = [];
                for (let i = 0; i < maxSlots; i++) {
                    const isUsed = (usedSlots[level] || []).includes(i);
                    circlesHTML.push(`<div class="slot-circle-mini ${isUsed ? 'used' : ''}" onclick="toggleSpellSlot(${level}, ${i})"></div>`);
                }

                slotDiv.innerHTML = `
                    <div class="level">Stufe ${level}</div>
                    <div class="circles">${circlesHTML.join('')}</div>
                `;
                slotsContainer.appendChild(slotDiv);
            }
        }

        async function loadSpells(char) {
            try {
                const response = await fetch(`${API_URL}?action=spells&class=bard`);
                const result = await response.json();

                if (result.success) {
                    const knownSpells = JSON.parse(char.known_spells || '[]');
                    const spellsList = document.getElementById('spellsList');
                    spellsList.innerHTML = '';

                    const filteredSpells = result.data.filter(spell => knownSpells.includes(spell.id));

                    filteredSpells.forEach(spell => {
                        const div = document.createElement('div');
                        div.className = 'spell-compact';
                        div.dataset.level = spell.level;
                        if (spell.ritual) div.classList.add('ritual');
                        if (spell.concentration) div.classList.add('concentration');

                        div.innerHTML = `
                            <div class="spell-header">
                                <span class="spell-name">${spell.name_de}</span>
                                <span class="spell-level">${spell.level === 0 ? 'Zaubertrick' : 'Stufe ' + spell.level}</span>
                            </div>
                            <div class="spell-details">
                                ${spell.school_de} ‚Ä¢ ${spell.casting_time_de} ‚Ä¢ ${spell.range_de}
                                ${spell.ritual ? ' ‚Ä¢ <span style="color: #ffd700;">Ritual</span>' : ''}
                                ${spell.concentration ? ' ‚Ä¢ <span style="color: #ff9800;">Konzentration</span>' : ''}
                            </div>
                            <div class="spell-description">${spell.description_de}</div>
                        `;

                        div.onclick = () => div.classList.toggle('expanded');
                        spellsList.appendChild(div);
                    });

                    filterSpells(currentSpellFilter);
                }
            } catch (error) {
                console.error('Fehler beim Laden der Zauber:', error);
            }
        }

        function filterSpells(level) {
            currentSpellFilter = level;
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.level == level);
            });

            const spells = document.querySelectorAll('.spell-compact');
            spells.forEach(spell => {
                if (level === 'all') {
                    spell.style.display = 'block';
                } else {
                    spell.style.display = spell.dataset.level == level ? 'block' : 'none';
                }
            });
        }

        function loadEquipment(char) {
            const equipmentList = document.getElementById('equipmentList');
            equipmentList.innerHTML = '';

            const inventory = JSON.parse(char.inventory || '[]');

            if (inventory.length === 0) {
                equipmentList.innerHTML = '<p style="color: #ce93d8; text-align: center;">Keine Ausr√ºstung</p>';
                return;
            }

            inventory.forEach(item => {
                const div = document.createElement('div');
                div.className = 'stat-compact';
                div.innerHTML = `
                    <span class="stat-name">${item.name}</span>
                    <span>${item.quantity || 1}√ó</span>
                `;
                equipmentList.appendChild(div);
            });
        }

        function toggleSpellSlot(level, index) {
            // TODO: Implement spell slot toggling with API call
            const circle = event.target;
            circle.classList.toggle('used');
        }

        function getProficiencyBonus(level) {
            return Math.ceil(level / 4) + 1;
        }

        function adjustHP(amount) {
            const current = parseInt(document.getElementById('currentHP').textContent);
            const max = parseInt(document.getElementById('maxHP').textContent);
            const newHP = Math.max(0, Math.min(max, current + amount));
            document.getElementById('currentHP').textContent = newHP;
            updateCharacterHP(newHP);
        }

        async function updateCharacterHP(newHP) {
            try {
                const formData = new FormData();
                formData.append('action', 'update_hp');
                formData.append('character_id', characterId);
                formData.append('current_hp', newHP);
                await fetch(API_URL, { method: 'POST', body: formData });
            } catch (error) {
                console.error('Fehler beim Speichern der HP:', error);
            }
        }

        async function shortRest() {
            if (confirm('Kurze Rast nehmen? (1 Stunde)')) {
                try {
                    const response = await fetch(`${API_URL}?action=short_rest&character_id=${characterId}`);
                    const result = await response.json();
                    if (result.success) {
                        alert('Kurze Rast abgeschlossen!');
                        loadCharacter();
                    }
                } catch (error) {
                    console.error('Fehler bei kurzer Rast:', error);
                }
            }
        }

        async function longRest() {
            if (confirm('Lange Rast nehmen? (8 Stunden) HP und alle Zauberpl√§tze werden wiederhergestellt.')) {
                try {
                    const response = await fetch(`${API_URL}?action=long_rest&character_id=${characterId}`);
                    const result = await response.json();
                    if (result.success) {
                        alert('Lange Rast abgeschlossen!');
                        loadCharacter();
                    }
                } catch (error) {
                    console.error('Fehler bei langer Rast:', error);
                }
            }
        }

        function showEquipmentTab() {
            alert('Ausr√ºstungsverwaltung wird geladen...');
        }

        function showNotesTab() {
            alert('Notizfunktion wird geladen...');
        }

        function showEquipmentBrowser() {
            alert('Ausr√ºstungs-Browser wird geladen...');
        }

        window.addEventListener('load', () => {
            loadCharacter();
        });
    </script>
</body>
</html>
